{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}ë°ì´í„° ìˆ˜ì§‘ ê´€ë¦¬{% endblock %}
{% block content %}
<style>
  .table {
    font-size: 0.9rem;
  }
  .table td, .table th {
    white-space: nowrap;
  }
  @media (max-width: 768px) {
    .table-responsive {
      font-size: 0.85rem;
    }
    .table thead th {
      white-space: nowrap;
    }
    .table td, .table th {
      min-width: 140px;
    }
  }
  [data-bs-theme="dark"] .table {
    color: #e9ecef;
  }
  [data-bs-theme="dark"] .table-bordered {
    border-color: #495057;
  }
  [data-bs-theme="dark"] .table-light {
    background-color: #343a40;
  }
  [data-bs-theme="dark"] .table-light th {
    background-color: #343a40;
    color: #e9ecef;
  }
  [data-bs-theme="dark"] .bg-light {
    background-color: #343a40 !important;
    color: #e9ecef !important;
  }
  [data-bs-theme="dark"] .text-muted {
    color: #adb5bd !important;
  }
  .table thead th {
    vertical-align: middle !important;
    padding: 0.5rem;
  }
  .main-card {
    background-color: #f8f9fa;
    padding: 1.2rem;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid #e9ecef;
  }
  [data-bs-theme="dark"] .main-card {
    background-color: #343a40;
    border-color: #495057;
  }
  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0.5rem;
  }
  [data-bs-theme="dark"] .section-title {
    color: #e9ecef;
    border-bottom-color: #495057;
  }
  .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  [data-bs-theme="dark"] .form-label {
    color: #e9ecef;
  }
  .card {
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  [data-bs-theme="dark"] .card {
    background-color: #2b3035;
    border-color: #495057;
  }
  .card-title {
    color: #495057;
    font-weight: 600;
    font-size: 0.95rem;
  }
  [data-bs-theme="dark"] .card-title {
    color: #e9ecef;
  }
  .btn {
    border-radius: 0.375rem;
    font-weight: 500;
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
  .btn-success {
    background-color: #198754;
    border-color: #198754;
  }
  .btn-success:hover {
    background-color: #157347;
    border-color: #157347;
  }
  .btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }
  .btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0b5ed7;
  }
  .btn-outline-info {
    color: #0dcaf0;
    border-color: #0dcaf0;
  }
  .btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #fff;
  }
  .form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    font-size: 0.9rem;
    padding: 0.4rem 0.75rem;
  }
  .form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  [data-bs-theme="dark"] .form-control,
  [data-bs-theme="dark"] .form-select {
    background-color: #2b3035;
    border-color: #495057;
    color: #e9ecef;
  }
  [data-bs-theme="dark"] .form-control:focus,
  [data-bs-theme="dark"] .form-select:focus {
    background-color: #2b3035;
    border-color: #86b7fe;
    color: #e9ecef;
  }
  .gap-2 {
    gap: 0.5rem !important;
  }
  .d-none {
    display: none !important;
  }
</style>
<div class="container-fluid">
  <h2 class="mb-4 fw-bold">ë°ì´í„° ìˆ˜ì§‘ ê´€ë¦¬</h2>
  
  <!-- ìë™ ìˆ˜ì§‘ ì£¼ê¸° ì„¤ì • -->
  <div class="main-card mb-3">
    <div class="section-title">ìë™ ìˆ˜ì§‘ ì„¤ì •</div>
    <div class="row">
      <div class="col-md-4">
        <label class="form-label">ìë™ ìˆ˜ì§‘ ì£¼ê¸°</label>
        <select id="autoFetchDays" class="form-select">
          <option value="0">ì‚¬ìš© ì•ˆ í•¨</option>
          <option value="1">ë§¤ì¼</option>
          <option value="3">3ì¼ë§ˆë‹¤</option>
          <option value="7">7ì¼ë§ˆë‹¤</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ìˆ˜ë™ ë°ì´í„° ìˆ˜ì§‘ -->
  <div class="main-card">
    <div class="section-title">ìˆ˜ë™ ë°ì´í„° ìˆ˜ì§‘</div>
    <form id="dataCollectionForm">
      <!-- ê¸°ê°„ ì„¤ì • -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">ì‹œì‘ì¼</label>
          <input type="date" id="start_date" class="form-control" value="{{ week_ago|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">ì¢…ë£Œì¼</label>
          <input type="date" id="end_date" class="form-control" value="{{ today|date:'Y-m-d' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">í”Œë«í¼ ì„ íƒ</label>
          <select id="dataCollectionPlatform" class="form-select">
            <option value="">í”Œë«í¼ ì„ íƒ - ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„</option>
            {% for platform in platform_aliases_grouped.keys %}
              <option value="{{ platform }}">
                {{ display_name|get_item:platform }} - 
                {% if platform == 'adpost' or platform == 'taboola' %}
                  ê³„ì •ë³„ í™•ì¸
                {% elif last_fetched_times|get_item:platform %}
                  {{ last_fetched_times|get_item:platform|date:"Y-m-d H:i:s" }}
                {% else %}
                  ìˆ˜ì§‘ ì´ë ¥ ì—†ìŒ
                {% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- í”Œë«í¼ë³„ ì„¤ì • -->
      <div class="row g-3">
        <!-- Adpost ì„¤ì • -->
        <div class="col-md-6" id="adpostUploadUI" class="d-none">
          <div class="card border-light">
            <div class="card-body">
              <h6 class="card-title mb-3">ğŸ“Š Adpost ì„¤ì •</h6>
              <div class="mb-3">
                <label class="form-label">ê³„ì • ì„ íƒ</label>
                <select id="adpost_account" class="form-select">
                  <option value="">ê³„ì • ì„ íƒ</option>
                  {% for alias in platform_aliases_grouped.adpost %}
                    <option value="{{ alias }}">
                      {{ alias }} - 
                      {% if last_fetched_times|get_item:alias %}
                        {{ last_fetched_times|get_item:alias|date:"Y-m-d H:i:s" }}
                      {% else %}
                        ë°ì´í„° ì—†ìŒ
                      {% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div id="adpostFileUploadUI" class="d-none">
                <label class="form-label">íŒŒì¼ ì—…ë¡œë“œ</label>
                <div class="d-flex gap-2">
                  <input type="file" id="adpost_excel" accept=".csv,.xlsx,.xls" class="form-control">
                  <button type="button" onclick="uploadAdpostExcel()" class="btn btn-primary" style="min-width: 60px; white-space: nowrap;">ë“±ë¡</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Taboola ì„¤ì • -->
        <div class="col-md-6" id="taboolaUploadUI" class="d-none">
          <div class="card border-light">
            <div class="card-body">
              <h6 class="card-title mb-3">ğŸ“Š Taboola ì„¤ì •</h6>
              <div class="mb-3">
                <label class="form-label">ê³„ì • ì„ íƒ</label>
                <select id="taboola_account" class="form-select">
                  <option value="">ê³„ì • ì„ íƒ</option>
                  {% for alias in platform_aliases_grouped.taboola %}
                    <option value="{{ alias }}">
                      {{ alias }} - 
                      {% if last_fetched_times|get_item:alias %}
                        {{ last_fetched_times|get_item:alias|date:"Y-m-d H:i:s" }}
                      {% else %}
                        ë°ì´í„° ì—†ìŒ
                      {% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div id="taboolaFileUploadUI" class="d-none">
                <label class="form-label">íŒŒì¼ ì—…ë¡œë“œ</label>
                <div class="d-flex gap-2">
                  <input type="file" id="taboola_excel" accept=".csv,.xlsx,.xls" class="form-control">
                  <button type="button" onclick="uploadTaboolaExcel()" class="btn btn-primary" style="min-width: 60px; white-space: nowrap;">ë“±ë¡</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AdManager ì„¤ì • -->
        <div class="col-md-6" id="admanagerReportUI" class="d-none">
          <div class="card border-light">
            <div class="card-body">
              <h6 class="card-title mb-3">ğŸ“ˆ AdManager ì„¤ì •</h6>
              <div class="mb-3">
                <label class="form-label">ê³„ì • ì„ íƒ</label>
                <select id="admanager_account" class="form-select">
                  <option value="">ê³„ì • ì„ íƒ</option>
                  {% for alias in platform_aliases_grouped.admanager %}
                    <option value="{{ alias }}">
                      {{ alias }} - 
                      {% if last_fetched_times|get_item:alias %}
                        {{ last_fetched_times|get_item:alias|date:"Y-m-d H:i:s" }}
                      {% else %}
                        ë°ì´í„° ì—†ìŒ
                      {% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <button id="loadReportsBtn" class="btn btn-outline-info w-100 mb-2" style="display: none;">
                  ğŸ“Š ë³´ê³ ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <select id="admanager_report" class="form-select" style="display: none;">
                  <option value="">ë³´ê³ ì„œ ì„ íƒ</option>
                </select>
              </div>
              <button id="fetchAdmanagerDataBtn" class="btn btn-success w-100" style="display: none;">
                ğŸ”„ AdManager ë°ì´í„° ìˆ˜ì§‘
              </button>
            </div>
          </div>
        </div>

        <!-- ì¼ë°˜ í”Œë«í¼ ì„¤ì • -->
        <div class="col-md-6" id="platformFetchUI" class="d-none">
          <div class="card border-light">
            <div class="card-body">
              <h6 class="card-title mb-3">ğŸ“Š ë°ì´í„° ìˆ˜ì§‘</h6>
              <button id="fetchDataBtn" class="btn btn-success w-100">
                ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="section-title mt-4 mb-2">ìˆ˜ì§‘ ì´ë ¥</div>
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>í”Œë«í¼</th>
          <th>ê³„ì •</th>
          <th>ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        {% for platform in platform_aliases_grouped.keys %}
          {% if platform == 'adpost' or platform == 'taboola' %}
            {% for alias in platform_aliases_grouped|get_item:platform %}
              <tr>
                <td>{{ display_name|get_item:platform }}</td>
                <td>{{ alias }}</td>
                <td>
                  {% if last_fetched_times|get_item:alias %}
                    {{ last_fetched_times|get_item:alias|date:"Y-m-d H:i:s" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if last_fetched_times|get_item:alias %}
                    <span class="badge bg-success">ì •ìƒ</span>
                  {% else %}
                    <span class="badge bg-warning">ë¯¸ìˆ˜ì§‘</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td>{{ display_name|get_item:platform }}</td>
              <td>-</td>
              <td>
                {% if last_fetched_times|get_item:platform %}
                  {{ last_fetched_times|get_item:platform|date:"Y-m-d H:i:s" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if last_fetched_times|get_item:platform %}
                  <span class="badge bg-success">ì •ìƒ</span>
                {% else %}
                  <span class="badge bg-warning">ë¯¸ìˆ˜ì§‘</span>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  const $ = id => document.getElementById(id);
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  fetch("/api/auto-fetch-days/")
    .then(res => res.json())
    .then(data => {
      $("autoFetchDays").value = data.days || "0";
    });
  $("autoFetchDays").addEventListener("change", () => {
    const days = $("autoFetchDays").value;
    fetch("/api/save-auto-fetch-setting/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: `days=${days}`
    });
  });
  function updatePlatformUI() {
    const platform = document.getElementById('dataCollectionPlatform').value;
    const adpostUI = document.getElementById('adpostUploadUI');
    const adpostFileUI = document.getElementById('adpostFileUploadUI');
    const taboolaUI = document.getElementById('taboolaUploadUI');
    const taboolaFileUI = document.getElementById('taboolaFileUploadUI');
    const admanagerUI = document.getElementById('admanagerReportUI');
    const platformUI = document.getElementById('platformFetchUI');
    adpostUI.classList.add('d-none');
    adpostFileUI.classList.add('d-none');
    taboolaUI.classList.add('d-none');
    taboolaFileUI.classList.add('d-none');
    admanagerUI.classList.add('d-none');
    platformUI.classList.add('d-none');
    if (!platform) {
      return;
    }
    if (platform === 'adpost') {
      adpostUI.classList.remove('d-none');
    } else if (platform === 'taboola') {
      taboolaUI.classList.remove('d-none');
    } else if (platform === 'admanager') {
      admanagerUI.classList.remove('d-none');
    } else {
      platformUI.classList.remove('d-none');
    }
  }
  document.getElementById('adpost_account').addEventListener('change', function() {
    const adpostFileUI = document.getElementById('adpostFileUploadUI');
    if (this.value) {
      adpostFileUI.classList.remove('d-none');
    } else {
      adpostFileUI.classList.add('d-none');
    }
  });
  document.getElementById('taboola_account').addEventListener('change', function() {
    const taboolaFileUI = document.getElementById('taboolaFileUploadUI');
    if (this.value) {
      taboolaFileUI.classList.remove('d-none');
    } else {
      taboolaFileUI.classList.add('d-none');
    }
  });
  document.getElementById('admanager_account').addEventListener('change', async function() {
    const loadReportsBtn = document.getElementById('loadReportsBtn');
    const reportSelect = document.getElementById('admanager_report');
    const fetchAdmanagerDataBtn = document.getElementById('fetchAdmanagerDataBtn');
    
    if (this.value) {
      // ê³„ì • ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ë³´ê³ ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      loadReportsBtn.style.display = 'none';
      reportSelect.style.display = 'none';
      fetchAdmanagerDataBtn.style.display = 'none';
      
      // ë¡œë”© ìƒíƒœ í‘œì‹œ
      reportSelect.innerHTML = '<option value="">â³ ë³´ê³ ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';
      reportSelect.style.display = 'block';
      
      try {
        const response = await fetch(`/api/admanager/reports/?alias=${encodeURIComponent(this.value)}`, {
          method: "GET",
          headers: {
            "X-CSRFToken": getCookie("csrftoken")
          }
        });

        const result = await response.json();
        
        if (result.status === "success") {
          reportSelect.innerHTML = '<option value="">ë³´ê³ ì„œ ì„ íƒ</option>';
          result.reports.forEach(report => {
            const option = document.createElement('option');
            option.value = report.id;
            option.textContent = `${report.name} (${report.status})`;
            reportSelect.appendChild(option);
          });
        } else {
          reportSelect.innerHTML = '<option value="">âŒ ë³´ê³ ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>';
          alert('ë³´ê³ ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message);
        }
      } catch (error) {
        reportSelect.innerHTML = '<option value="">âŒ ë³´ê³ ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</option>';
        alert('ë³´ê³ ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    } else {
      loadReportsBtn.style.display = 'none';
      reportSelect.style.display = 'none';
      fetchAdmanagerDataBtn.style.display = 'none';
    }
  });
  document.getElementById('admanager_report').addEventListener('change', function() {
    const fetchAdmanagerDataBtn = document.getElementById('fetchAdmanagerDataBtn');
    if (this.value) {
      fetchAdmanagerDataBtn.style.display = 'block';
    } else {
      fetchAdmanagerDataBtn.style.display = 'none';
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    updatePlatformUI();
  });
  document.getElementById('dataCollectionPlatform').addEventListener('change', updatePlatformUI);
  document.getElementById('fetchDataBtn').addEventListener('click', async function() {
    const platform = document.getElementById('dataCollectionPlatform').value;
    const btn = this;
    btn.disabled = true;
    btn.textContent = "â³ ìˆ˜ì§‘ ì¤‘...";
    try {
      const startDate = document.getElementById("start_date").value;
      const endDate = document.getElementById("end_date").value;
      if (!startDate || !endDate) {
        alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        btn.disabled = false;
        btn.textContent = "ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°";
        return;
      }

      let requestBody = {
        start_date: startDate,
        end_date: endDate
      };

      // AdManagerì˜ ê²½ìš° ë³´ê³ ì„œ ID ì¶”ê°€
      if (platform === 'admanager') {
        const reportSelect = document.getElementById('admanager_report');
        if (reportSelect.value) {
          requestBody.report_id = reportSelect.value;
        }
      }

      const response = await fetch(`/api/fetch/${platform}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(requestBody)
      });
      const result = await response.json();
      if (result.results) {
        const log = result.results.map(r =>
          `â€¢ ${r.alias} â†’ ${r.status === "success" ? "âœ… ì„±ê³µ" : "âŒ ì‹¤íŒ¨ (" + r.message + ")"}`
        ).join("\n");
        alert(`${platform} ìˆ˜ì§‘ ê²°ê³¼:\n${log}`);
      }
    } catch (err) {
      alert("âŒ ì˜¤ë¥˜: " + err.message);
    }
    btn.disabled = false;
    btn.textContent = "ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°";
    location.reload();
  });
  async function uploadAdpostExcel() {
    const accountSelect = document.getElementById('adpost_account');
    const fileInput = document.getElementById('adpost_excel');
    if (!accountSelect.value) {
      alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!fileInput.files.length) {
      alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const file = fileInput.files[0];
    const fileExt = file.name.split('.').pop().toLowerCase();
    if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (ì§€ì›: csv, xlsx, xls)');
      return;
    }
    const formData = new FormData();
    formData.append('file', file);
    formData.append('account_id', accountSelect.value);
    try {
      const response = await fetch('/api/adpost/upload/', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      if (response.ok) {
        let message = result.message;
        if (result.error_count > 0) {
          message += '\n\nì²˜ë¦¬ ì‹¤íŒ¨í•œ ë°ì´í„°:';
          result.errors.forEach(error => {
            message += '\n' + error;
          });
          alert(message);
          // ì‹¤íŒ¨ê°€ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ
        } else {
          alert(message);
          fileInput.value = '';
          location.reload();
        }
      } else {
        let errorMessage = result.error || 'ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (result.details) {
          errorMessage += '\n\nìƒì„¸ ì˜¤ë¥˜:';
          result.details.forEach(detail => {
            errorMessage += '\n' + detail;
          });
        }
        alert(errorMessage);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
  async function uploadTaboolaExcel() {
    const accountSelect = document.getElementById('taboola_account');
    const fileInput = document.getElementById('taboola_excel');
    if (!accountSelect.value) {
      alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!fileInput.files.length) {
      alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const file = fileInput.files[0];
    const fileExt = file.name.split('.').pop().toLowerCase();
    if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (ì§€ì›: csv, xlsx, xls)');
      return;
    }
    const formData = new FormData();
    formData.append('file', file);
    formData.append('account_id', accountSelect.value);
    try {
      console.log('Taboola íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', file.name, 'ê³„ì •:', accountSelect.value);
      const response = await fetch('/api/taboola/upload/', {
        method: 'POST',
        body: formData
      });
      console.log('Taboola ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
      const result = await response.json();
      console.log('Taboola ì‘ë‹µ ë‚´ìš©:', result);
      if (response.ok) {
        let message = result.message;
        if (result.error_count > 0) {
          message += '\n\nì²˜ë¦¬ ì‹¤íŒ¨í•œ ë°ì´í„°:';
          result.errors.forEach(error => {
            message += '\n' + error;
          });
          alert(message);
          // ì‹¤íŒ¨ê°€ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•ŠìŒ
        } else {
          alert(message);
          fileInput.value = '';
          location.reload();
        }
      } else {
        let errorMessage = result.error || 'ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (result.details) {
          errorMessage += '\n\nìƒì„¸ ì˜¤ë¥˜:';
          result.details.forEach(detail => {
            errorMessage += '\n' + detail;
          });
        }
        alert(errorMessage);
      }
    } catch (error) {
      console.error('Taboola ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
  document.getElementById('fetchAdmanagerDataBtn').addEventListener('click', async function() {
    const accountSelect = document.getElementById('admanager_account');
    const reportSelect = document.getElementById('admanager_report');
    const btn = this;
    
    if (!accountSelect.value) {
      alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (!reportSelect.value) {
      alert('ë³´ê³ ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    btn.disabled = true;
    btn.textContent = "â³ ìˆ˜ì§‘ ì¤‘...";
    
    try {
      const startDate = document.getElementById("start_date").value;
      const endDate = document.getElementById("end_date").value;
      if (!startDate || !endDate) {
        alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        btn.disabled = false;
        btn.textContent = "ğŸ”„ AdManager ë°ì´í„° ìˆ˜ì§‘";
        return;
      }

      const requestBody = {
        start_date: startDate,
        end_date: endDate,
        report_id: reportSelect.value
      };

      const response = await fetch(`/api/fetch/admanager/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(requestBody)
      });
      
      const result = await response.json();
      if (result.results) {
        const log = result.results.map(r =>
          `â€¢ ${r.alias} â†’ ${r.status === "success" ? "âœ… ì„±ê³µ" : "âŒ ì‹¤íŒ¨ (" + r.message + ")"}`
        ).join("\n");
        alert(`AdManager ìˆ˜ì§‘ ê²°ê³¼:\n${log}`);
      } else {
        alert('ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    } catch (err) {
      alert("âŒ ì˜¤ë¥˜: " + err.message);
    }
    
    btn.disabled = false;
    btn.textContent = "ğŸ”„ AdManager ë°ì´í„° ìˆ˜ì§‘";
    location.reload();
  });
</script>
{% endblock %} 