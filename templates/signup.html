{% extends "base.html" %}
{% block title %}회원가입{% endblock %}
{% block body_class %}auth-page{% endblock %}
{% block sidebar %}{% endblock %}
{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}
{% block content %}

<div class="container">
  <div class="row justify-content-center align-items-center min-vh-100">
    <div class="col-12 col-md-8 col-lg-6 col-xl-5">
      <div class="card border-0 shadow-lg">
        <div class="card-body p-5">
          <!-- 로고 및 타이틀 -->
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary mb-2">광고 플랫폼</h2>
            <p class="text-muted">통합관리 시스템</p>
          </div>

          <!-- 회원가입 폼 -->
          <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            {% if messages %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {% for message in messages %}
                {{ message }}
              {% endfor %}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <!-- 계정 유형 선택 -->
            <!-- <div class="mb-3">
              <label class="form-label">계정 유형</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="account_type" id="mainAccount" value="main" required>
                <label class="form-check-label" for="mainAccount">
                  메인 계정
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="account_type" id="subAccount" value="sub" required>
                <label class="form-check-label" for="subAccount">
                  서브 계정
                </label>
              </div>
            </div> -->
            <input type="hidden" name="account_type" value="main">

            <!-- 이름 입력 -->
            <div class="form-floating mb-3">
              <input type="text" name="name" class="form-control" id="id_name" placeholder="이름" required>
              <label for="id_name">이름</label>
            </div>

            <!-- 아이디 입력 -->
            <div class="form-floating mb-3">
              <input type="text" name="username" class="form-control" id="id_username" placeholder="아이디" required>
              <label for="id_username">아이디</label>
              <div class="invalid-feedback">이미 사용 중인 아이디입니다.</div>
            </div>

            <!-- 이메일 입력 -->
            <div class="form-floating mb-3">
              <input type="email" name="email" class="form-control" id="id_email" placeholder="이메일" required>
              <label for="id_email">이메일</label>
              <div class="invalid-feedback">이미 사용 중인 이메일입니다.</div>
            </div>

            <!-- 비밀번호 입력 -->
            <div class="form-floating mb-3">
              <input type="password" name="password1" class="form-control" id="id_password1" placeholder="비밀번호" required>
              <label for="id_password1">비밀번호</label>
            </div>

            <!-- 비밀번호 확인 -->
            <div class="form-floating mb-3">
              <input type="password" name="password2" class="form-control" id="id_password2" placeholder="비밀번호 확인" required>
              <label for="id_password2">비밀번호 확인</label>
            </div>

            <!-- 메인 계정 아이디 입력 (서브 계정일 경우에만 표시) -->
            <div class="form-floating mb-3" id="mainAccountContainer" style="display: none;">
              <input type="text" name="main_account" class="form-control" id="id_main_account" placeholder="메인 계정 아이디">
              <label for="id_main_account">메인 계정 아이디</label>
              <small class="form-text text-muted">서브 계정인 경우 메인 계정의 아이디를 입력해주세요.</small>
              <div class="invalid-feedback">존재하지 않는 메인계정 ID입니다.</div>
            </div>

            <!-- 가입 버튼 -->
            <div class="d-grid mb-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-person-plus me-2"></i>회원가입
              </button>
            </div>

            <!-- 로그인 링크 -->
            <div class="text-center">
              <p class="mb-0 text-muted">
                이미 계정이 있으신가요? 
                <a href="{% url 'login' %}" class="text-primary text-decoration-none">로그인</a>
              </p>
            </div>
          </form>
        </div>
      </div>

      <!-- 푸터 텍스트 -->
      <div class="text-center mt-4">
        <p class="text-muted small">
          &copy; 2025 광고 플랫폼 통합관리. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- 계정 유형 선택에 따른 메인 계정 입력 필드 표시/숨김 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const mainAccount = document.getElementById('mainAccount');
  const subAccount = document.getElementById('subAccount');
  const mainAccountContainer = document.getElementById('mainAccountContainer');
  const mainAccountInput = document.getElementById('id_main_account');
  const usernameInput = document.getElementById('id_username');
  const emailInput = document.getElementById('id_email');
  const form = document.querySelector('form');

  // 아이디 중복 체크
  usernameInput.addEventListener('input', async function() {
    if (this.value.trim() !== '') {
      try {
        const response = await fetch(`/api/check-username/?username=${encodeURIComponent(this.value)}`);
        const data = await response.json();
        
        if (data.exists) {
          this.setCustomValidity('이미 사용 중인 아이디입니다.');
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        } else {
          this.setCustomValidity('');
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        }
      } catch (error) {
        console.error('아이디 중복 체크 중 오류 발생:', error);
      }
    }
  });

  // 이메일 중복 체크
  emailInput.addEventListener('input', async function() {
    if (this.value.trim() !== '') {
      try {
        const response = await fetch(`/api/check-email/?email=${encodeURIComponent(this.value)}`);
        const data = await response.json();
        
        if (data.exists) {
          this.setCustomValidity('이미 사용 중인 이메일입니다.');
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        } else {
          this.setCustomValidity('');
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        }
      } catch (error) {
        console.error('이메일 중복 체크 중 오류 발생:', error);
      }
    }
  });

  // 메인계정 ID 실시간 검증
  mainAccountInput.addEventListener('input', async function() {
    if (subAccount.checked && this.value.trim() !== '') {
      try {
        const response = await fetch(`/api/check-main-account/?username=${encodeURIComponent(this.value)}`);
        const data = await response.json();
        
        if (data.exists) {
          this.setCustomValidity('');
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.setCustomValidity('존재하지 않는 메인계정 ID입니다.');
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        }
      } catch (error) {
        console.error('메인계정 검증 중 오류 발생:', error);
      }
    }
  });

  function toggleMainAccountField() {
    if (subAccount.checked) {
      mainAccountContainer.style.display = 'block';
      mainAccountInput.required = true;
      mainAccountInput.setAttribute('aria-required', 'true');
    } else {
      mainAccountContainer.style.display = 'none';
      mainAccountInput.required = false;
      mainAccountInput.removeAttribute('aria-required');
      mainAccountInput.value = '';
      mainAccountInput.setCustomValidity('');
      mainAccountInput.classList.remove('is-valid', 'is-invalid');
    }
  }

  mainAccount.addEventListener('change', toggleMainAccountField);
  subAccount.addEventListener('change', toggleMainAccountField);

  // 폼 제출 시 유효성 검사
  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    if (!form.checkValidity()) {
      event.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    // 서브계정인 경우 메인계정 ID 검증
    if (subAccount.checked) {
      try {
        const response = await fetch(`/api/check-main-account/?username=${encodeURIComponent(mainAccountInput.value)}`);
        const data = await response.json();
        
        if (!data.exists) {
          mainAccountInput.setCustomValidity('존재하지 않는 메인계정 ID입니다.');
          mainAccountInput.classList.add('is-invalid');
          form.classList.add('was-validated');
          return;
        }
      } catch (error) {
        console.error('메인계정 검증 중 오류 발생:', error);
        return;
      }
    }

    // 모든 검증을 통과하면 폼 제출
    form.submit();
  }, false);
});
</script>

{% endblock %}
