{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% load custom_filters %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<h2 class="mb-4 text-center">ğŸ“Š ìˆ˜ìµ ëŒ€ì‹œë³´ë“œ</h2>

<!-- âœ… í”Œë«í¼ë³„ ìˆ˜ì§‘ ë²„íŠ¼ -->
<div class="mb-3 text-end">
  <div class="mb-4">
    <label class="form-label">ìë™ ìˆ˜ì§‘ ì£¼ê¸°</label>
    <select id="autoFetchDays" class="form-select form-select-sm d-inline-block" style="width: 100px;">
      <option value="0">ì‚¬ìš© ì•ˆ í•¨</option>
      <option value="1">ë§¤ì¼</option>
      <option value="3">3ì¼ë§ˆë‹¤</option>
      <option value="7">7ì¼ë§ˆë‹¤</option>
    </select>
  </div>

  <div class="mb-1">
    <div class="d-flex align-items-center justify-content-end gap-2">
      <select id="dataCollectionPlatform" class="form-select form-select-sm" style="width: 280px;">
        <option value="">í”Œë«í¼ ì„ íƒ - ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„</option>
        {% for platform in platform_aliases_grouped.keys %}
          <option value="{{ platform }}">
            {{ cred.platform }} - 
            {% if platform == 'adpost' %}
              ê³„ì •ë³„ í™•ì¸
            {% elif last_fetched_times|get_item:platform %}
              {{ last_fetched_times|get_item:platform|date:"Y-m-d H:i:s" }}
            {% else %}
              ìˆ˜ì§‘ ì´ë ¥ ì—†ìŒ
            {% endif %}
          </option>
        {% endfor %}
      </select>

      <!-- Adpost ë°ì´í„° ì—…ë¡œë“œ UI -->
      <div id="adpostUploadUI" class="d-none">
        <select id="adpost_account" class="form-select form-select-sm" style="width: 300px;">
          <option value="">ê³„ì • ì„ íƒ</option>
          {% for alias in platform_aliases_grouped.adpost %}
            <option value="{{ alias }}">
              {{ alias }} - 
              {% if last_fetched_times|get_item:alias %}
                {{ last_fetched_times|get_item:alias|date:"Y-m-d H:i:s" }}
              {% else %}
                ë°ì´í„° ì—†ìŒ
              {% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- ê¸°íƒ€ í”Œë«í¼ ë°ì´í„° ìˆ˜ì§‘ ë²„íŠ¼ -->
      <div id="platformFetchUI" class="d-none d-flex align-items-center gap-2">
        <button id="fetchDataBtn" class="btn btn-outline-success btn-sm">
          ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
      </div>
    </div>

    <!-- Adpost íŒŒì¼ ì—…ë¡œë“œ UI -->
    <div id="adpostFileUploadUI" class="d-none d-flex align-items-center justify-content-end gap-2 mt-2">
      <input type="file" id="adpost_excel" accept=".csv,.xlsx,.xls" class="form-control form-control-sm" style="width: 266px;">
      <button onclick="uploadAdpostExcel()" class="btn btn-outline-primary btn-sm">ë°ì´í„° ë“±ë¡</button>
    </div>
  </div>
</div>

<!-- âœ… í•„í„° UI -->
<form class="container-fluid mb-4">
  <div class="row g-2 mb-2">
    <div class="col-6 col-md-auto">
      <label class="form-label">ì‹œì‘ì¼</label>
      <input type="date" id="start_date" class="form-control" />
    </div>
    <div class="col-6 col-md-auto">
      <label class="form-label">ì¢…ë£Œì¼</label>
      <input type="date" id="end_date" class="form-control" />
    </div>
  </div>

  <div class="row g-2 mb-2">
    <div class="col-6 col-md-auto">
      <label class="form-label">í”Œë«í¼</label>
      <select id="platformSelector" class="form-select">
        <option value="all">ì „ì²´</option>
        {% for platform in platform_aliases_grouped.keys %}
          <option value="{{ platform }}"> {{ platform|platform_display }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-auto">
      <label class="form-label">ê³„ì •</label>
      <select id="accountSelector" class="form-select">
        <option value="all">ì „ì²´</option>
      </select>
    </div>
    <div class="col-6 col-md-auto">
      <label class="form-label">ê´‘ê³  ë‹¨ìœ„</label>
      <select id="adUnitSelector" class="form-select">
        <option value="all">ì „ì²´</option>
      </select>
    </div>
  </div>

  <div class="row g-2 mb-2 justify-content-md-end">
    <div class="col-6 col-sm-4 col-md-auto">
      <label class="form-label">ê·¸ë˜í”„ ìœ í˜•</label>
      <select id="chartTypeSelector" class="form-select">
        <option value="bar" selected>ë§‰ëŒ€</option>
        <option value="line">ì„ </option>
      </select>
    </div>
    <div class="col-6 col-sm-4 col-md-auto">
      <label class="form-label">ë³´ê¸° ë‹¨ìœ„</label>
      <select id="groupingSelector" class="form-select">
        <option value="day">ì¼ë³„</option>
        <option value="month">ì›”ë³„</option>
      </select>
    </div>
    <div class="col-6 col-sm-4 col-md-auto">
      <label class="form-label">ì§€í‘œ</label>
      <select id="metricSelector" class="form-select">
        <option value="earnings">ìˆ˜ìµ</option>
        <option value="clicks">í´ë¦­ ìˆ˜</option>
        <option value="impressions">ê´‘ê³  ìš”ì²­ ìˆ˜</option>
        <option value="order_count">ì£¼ë¬¸ê±´ìˆ˜</option>
        <option value="total_amount">í•©ì‚°ê¸ˆì•¡</option>
        <option value="ctr">CTR (%)</option>
        <option value="ppc">PPC (ì›)</option>
      </select>
    </div>
  </div>
</form>

<canvas id="earningsChart" height="100" class="mb-5"></canvas>

<!-- ë°ì´í„° í…Œì´ë¸” -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h4 class="mb-0">ë°ì´í„° í…Œì´ë¸”</h4>
  <div>
    <button id="resetSortBtn" class="btn btn-sm btn-outline-secondary me-2">
      <i class="bi bi-arrow-counterclockwise"></i> ì •ë ¬ ì´ˆê¸°í™”
    </button>
    <button id="exportExcelBtn" class="btn btn-sm btn-success">
      <i class="bi bi-file-earmark-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    </button>
  </div>
</div>

<div class="table-responsive mt-4 mb-4">
  <table id="dataTable" class="table table-striped table-hover">
    <thead>
      <tr>
        <th class="sortable" data-sort="date">ë‚ ì§œ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="platform">í”Œë«í¼ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="alias">ê³„ì • <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="earnings">ìˆ˜ìµ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="clicks">í´ë¦­ ìˆ˜ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="impressions">ê´‘ê³  ìš”ì²­ ìˆ˜ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="order_count">ì£¼ë¬¸ê±´ìˆ˜ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="total_amount">í•©ì‚°ê¸ˆì•¡ <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="ctr">CTR (%) <span class="sort-icon"></span></th>
        <th class="sortable" data-sort="ppc">PPC <span class="sort-icon"></span></th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
  const $ = id => document.getElementById(id);
  let chart = null;
  let currentData = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ë°ì´í„° ì €ì¥
  const platformAliases = {{ platform_aliases_grouped|safe }};
  const credentialColors = {{ credential_colors|safe }};
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  // ì¿ í‚¤ ê´€ë ¨ í•¨ìˆ˜
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // ì‹œìŠ¤í…œ ë‹¤í¬ëª¨ë“œ ê°ì§€ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
  function updateChartTheme() {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (chart) {
      chart.options.plugins.title.color = isDarkMode ? "#ffffff" : "#000000";
      chart.options.plugins.legend.labels.color = isDarkMode ? "#ffffff" : "#000000";
      chart.options.scales.x.ticks.color = isDarkMode ? "#ffffff" : "#000000";
      chart.options.scales.x.grid.color = isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.05)";
      chart.options.scales.y.ticks.color = isDarkMode ? "#ffffff" : "#000000";
      chart.options.scales.y.grid.color = isDarkMode ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.05)";
      chart.options.scales.y.title.color = isDarkMode ? "#ffffff" : "#000000";
      chart.update();
    }
  }

  // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateChartTheme);

  // ì°¨íŠ¸ ì´ˆê¸°í™”
  function initChart() {
    const ctx = $("earningsChart").getContext("2d");
    chart = new Chart(ctx, {
      type: $("chartTypeSelector").value,
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: "ê³„ì •ë³„ ì§€í‘œ", color: "#000000" },
          legend: { labels: { color: "#000000" } }
        },
        scales: {
          x: { 
            ticks: { color: "#000000" },
            grid: { color: "rgba(0,0,0,0.05)" }
          },
          y: {
            ticks: { color: "#000000" },
            grid: { color: "rgba(0,0,0,0.05)" },
            title: { 
              display: true, 
              text: "", 
              color: "#000000" 
            }
          }
        }
      }
    });
  }

  // ê³„ì • ì„ íƒê¸° ì—…ë°ì´íŠ¸
  function updateAccountSelector() {
    const platform = $("platformSelector").value;
    const accountSelector = $("accountSelector");
    accountSelector.innerHTML = '<option value="all">ì „ì²´</option>';
    
    if (platform !== "all" && platformAliases[platform]) {
      platformAliases[platform].forEach(alias => {
        const option = document.createElement("option");
        option.value = alias;
        option.textContent = alias;
        accountSelector.appendChild(option);
      });
    }
    updateAdUnitSelector();
  }

  // ê´‘ê³  ë‹¨ìœ„ ì„ íƒê¸° ì—…ë°ì´íŠ¸
  async function updateAdUnitSelector() {
    const platform = $("platformSelector").value;
    const alias = $("accountSelector").value;
    const adUnitSelector = $("adUnitSelector");
    
    adUnitSelector.innerHTML = '<option value="all">ì „ì²´</option>';
    
    if (platform !== "all" && alias !== "all") {
      try {
        const response = await fetch(`/api/ad-units/?platform=${platform}&alias=${alias}`);
        if (!response.ok) {
          throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
        }
        const data = await response.json();
        
        if (data.ad_units && Array.isArray(data.ad_units)) {
          const adUnits = [...new Set(data.ad_units.map(item => ({
            id: item.ad_unit_id,
            name: item.ad_unit_name || item.ad_unit_id
          })))].sort((a, b) => a.name.localeCompare(b.name));
          
          adUnits.forEach(unit => {
            const option = document.createElement("option");
            option.value = unit.id;
            option.textContent = unit.name;
            adUnitSelector.appendChild(option);
          });
        }
      } catch (error) {
        console.error("ê´‘ê³  ë‹¨ìœ„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
      }
    }
    updateChart();
  }

  // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
  async function updateChart() {
    const startDate = $("start_date").value;
    const endDate = $("end_date").value;
    const platform = $("platformSelector").value;
    const alias = $("accountSelector").value;
    const adUnitId = $("adUnitSelector").value;
    const grouping = $("groupingSelector").value;
    const metric = $("metricSelector").value;

    if (!startDate || !endDate) return;

    try {
      const response = await fetch(
        `/api/stats/?start_date=${startDate}&end_date=${endDate}&platform=${platform}&alias=${alias}&ad_unit_id=${adUnitId}&grouping=${grouping}`
      );
      if (!response.ok) {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
      }
      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      currentData = data;

      // ë°ì´í„° ê·¸ë£¹í™” (ì°¨íŠ¸ìš©)
      const groupedData = {};
      data.forEach(stat => {
        const key = `${stat.platform}:${stat.alias}`;
        if (!groupedData[key]) {
          groupedData[key] = {
            label: key,
            data: [],
            color: credentialColors[key] || "#888888"
          };
        }
        groupedData[key].data.push({
          x: stat.date,
          y: stat[metric]
        });
      });

      // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
      const labels = [...new Set(data.map(stat => {
        const date = new Date(stat.date);
        return grouping === "month" ? 
          `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : 
          stat.date;
      }))].sort();

      const datasets = Object.values(groupedData).map(group => ({
        label: group.label,
        data: labels.map(date => {
          const item = group.data.find(d => {
            const itemDate = new Date(d.x);
            const itemDateStr = grouping === "month" ? 
              `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}` : 
              d.x;
            return itemDateStr === date;
          });
          return item ? item.y : 0;
        }),
        borderColor: group.color,
        backgroundColor: group.color,
        tension: 0.3,
        fill: false
      }));

      if (!chart) {
        initChart();
      }

      chart.config.type = $("chartTypeSelector").value;
      chart.options.plugins.title.text = `ê³„ì •ë³„ ì§€í‘œ â€“ ${metricLabels[metric]}`;
      chart.options.scales.y.title.text = metricYLabels[metric];
      chart.data.labels = labels;
      chart.data.datasets = datasets;
      chart.update();

      // í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸
      updateDataTable();

    } catch (error) {
      console.error("ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  // ì •ë ¬ ìƒíƒœ ê´€ë¦¬
  let currentSort = {
    field: 'date',
    direction: 'desc'
  };

  // ì •ë ¬ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
  document.addEventListener('DOMContentLoaded', () => {
    // ì •ë ¬ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('resetSortBtn').addEventListener('click', () => {
      currentSort = {
        field: 'date',
        direction: 'desc'
      };
      updateDataTable();
      updateSortIcons();
    });

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);

    // í…Œì´ë¸” í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
    document.querySelectorAll('.sortable').forEach(header => {
      header.addEventListener('click', () => {
        const field = header.dataset.sort;
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.field = field;
          currentSort.direction = 'asc';
        }
        updateDataTable();
        updateSortIcons();
      });
    });
  });

  // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  function updateSortIcons() {
    document.querySelectorAll('.sort-icon').forEach(icon => {
      icon.textContent = '';
    });
    const currentHeader = document.querySelector(`[data-sort="${currentSort.field}"]`);
    if (currentHeader) {
      const icon = currentHeader.querySelector('.sort-icon');
      icon.textContent = currentSort.direction === 'asc' ? 'â†‘' : 'â†“';
    }
  }

  // í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸
  function updateDataTable() {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    const grouping = $("groupingSelector").value;

    // ë°ì´í„° ì •ë ¬
    const sortedData = [...currentData].sort((a, b) => {
      let valueA = a[currentSort.field];
      let valueB = b[currentSort.field];

      // ë‚ ì§œ í•„ë“œ ì²˜ë¦¬
      if (currentSort.field === 'date') {
        valueA = new Date(valueA);
        valueB = new Date(valueB);
      }
      // ìˆ«ì í•„ë“œ ì²˜ë¦¬
      else if (['earnings', 'clicks', 'impressions', 'ctr', 'ppc'].includes(currentSort.field)) {
        valueA = parseFloat(valueA) || 0;
        valueB = parseFloat(valueB) || 0;
      }

      if (currentSort.direction === 'asc') {
        return valueA > valueB ? 1 : -1;
      } else {
        return valueA < valueB ? 1 : -1;
      }
    });

    // í•©ê³„ ê³„ì‚°
    let totalEarnings = 0;
    let totalClicks = 0;
    let totalImpressions = 0;
    let totalOrderCount = 0;
    let totalAmount = 0;

    sortedData.forEach(stat => {
      const row = document.createElement('tr');
      const dateStr = grouping === "month" ? stat.date.substring(0, 7) : stat.date;
      row.innerHTML = `
        <td>${dateStr}</td>
        <td>${stat.platform}</td>
        <td>${stat.alias}</td>
        <td>${formatNumber(stat.earnings)}</td>
        <td>${formatNumber(stat.clicks)}</td>
        <td>${formatNumber(stat.impressions)}</td>
        <td>${formatNumber(stat.order_count)}</td>
        <td>${formatNumber(stat.total_amount)}</td>
        <td>${formatNumber(stat.ctr)}</td>
        <td>${formatNumber(stat.ppc)}</td>
      `;
      tbody.appendChild(row);

      // í•©ê³„ ê³„ì‚°
      totalEarnings += parseFloat(stat.earnings) || 0;
      totalClicks += parseInt(stat.clicks) || 0;
      totalImpressions += parseInt(stat.impressions) || 0;
      totalOrderCount += parseInt(stat.order_count) || 0;
      totalAmount += parseFloat(stat.total_amount) || 0;
    });

    // í•©ê³„ í–‰ ì¶”ê°€ (CTRê³¼ PPCëŠ” ì´í•©ìœ¼ë¡œ ê³„ì‚°)
    const totalCtr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
    const totalPpc = totalClicks > 0 ? (totalEarnings / totalClicks) : 0;

    const totalRow = document.createElement('tr');
    totalRow.className = 'table-info';
    totalRow.innerHTML = `
      <td><strong>í•©ê³„/í‰ê· </strong></td>
      <td></td>
      <td></td>
      <td><strong>${formatNumber(totalEarnings)}</strong></td>
      <td><strong>${formatNumber(totalClicks)}</strong></td>
      <td><strong>${formatNumber(totalImpressions)}</strong></td>
      <td><strong>${formatNumber(totalOrderCount)}</strong></td>
      <td><strong>${formatNumber(totalAmount)}</strong></td>
      <td><strong>${formatNumber(totalCtr)}</strong></td>
      <td><strong>${formatNumber(totalPpc)}</strong></td>
    `;
    tbody.appendChild(totalRow);
  }

  // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
  function formatNumber(value) {
    if (value === null || value === undefined) return '-';
    if (typeof value === 'number') {
      if (Number.isInteger(value)) {
        return value.toLocaleString();
      } else {
        // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œì‹œí•˜ë©´ì„œ ì²œ ë‹¨ìœ„ êµ¬ë¶„ ì ìš©
        return value.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }
    }
    return value;
  }

  // ì§€í‘œ ë ˆì´ë¸”
  const metricLabels = {
    earnings: "ìˆ˜ìµ",
    clicks: "í´ë¦­ ìˆ˜",
    impressions: "ê´‘ê³  ìš”ì²­ ìˆ˜",
    order_count: "ì£¼ë¬¸ê±´ìˆ˜",
    total_amount: "í•©ì‚°ê¸ˆì•¡",
    ctr: "CTR (%)",
    ppc: "PPC (ì›)"
  };

  const metricYLabels = {
    earnings: "ìˆ˜ìµ (â‚©)",
    clicks: "í´ë¦­ ìˆ˜",
    impressions: "ê´‘ê³  ìš”ì²­ ìˆ˜",
    order_count: "ì£¼ë¬¸ê±´ìˆ˜",
    total_amount: "í•©ì‚°ê¸ˆì•¡ (â‚©)",
    ctr: "CTR (%)",
    ppc: "í´ë¦­ë‹¹ ë‹¨ê°€ (â‚©)"
  };

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  $("platformSelector").addEventListener("change", updateAccountSelector);
  $("accountSelector").addEventListener("change", updateAdUnitSelector);
  $("adUnitSelector").addEventListener("change", updateChart);
  $("start_date").addEventListener("change", updateChart);
  $("end_date").addEventListener("change", updateChart);
  $("groupingSelector").addEventListener("change", updateChart);
  $("metricSelector").addEventListener("change", updateChart);
  $("chartTypeSelector").addEventListener("change", updateChart);

  // ì´ˆê¸°í™”
  const today = new Date();
  const weekAgo = new Date(today);
  weekAgo.setDate(today.getDate() - 7);
  $("start_date").value = weekAgo.toISOString().slice(0, 10);
  $("end_date").value = today.toISOString().slice(0, 10);

  updateAccountSelector();
  initChart();
  updateChart();

  // ìë™ ìˆ˜ì§‘ ì„¤ì •
  fetch("/api/auto-fetch-days/")
    .then(res => res.json())
    .then(data => {
      $("autoFetchDays").value = data.days || "0";
    });

  $("autoFetchDays").addEventListener("change", () => {
    const days = $("autoFetchDays").value;
    fetch("/api/save-auto-fetch-setting/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: `days=${days}`
    });
  });

  // í”Œë«í¼ ì„ íƒì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
  function updatePlatformUI() {
    const platform = document.getElementById('dataCollectionPlatform').value;
    const adpostUI = document.getElementById('adpostUploadUI');
    const adpostFileUI = document.getElementById('adpostFileUploadUI');
    const platformUI = document.getElementById('platformFetchUI');
    
    // ëª¨ë“  UI ìˆ¨ê¸°ê¸°
    adpostUI.classList.add('d-none');
    adpostFileUI.classList.add('d-none');
    platformUI.classList.add('d-none');
    
    // í”Œë«í¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì¢…ë£Œ
    if (!platform) {
      return;
    }
    
    // ì„ íƒëœ í”Œë«í¼ì— ë”°ë¼ UI í‘œì‹œ
    if (platform === 'adpost') {
      adpostUI.classList.remove('d-none');
    } else {
      platformUI.classList.remove('d-none');
    }
  }

  // ê³„ì • ì„ íƒ ì‹œ íŒŒì¼ ì—…ë¡œë“œ UI í‘œì‹œ
  document.getElementById('adpost_account').addEventListener('change', function() {
    const adpostFileUI = document.getElementById('adpostFileUploadUI');
    if (this.value) {
      adpostFileUI.classList.remove('d-none');
    } else {
      adpostFileUI.classList.add('d-none');
    }
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ UI ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', function() {
    updatePlatformUI();
  });

  // í”Œë«í¼ ì„ íƒ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
  document.getElementById('dataCollectionPlatform').addEventListener('change', updatePlatformUI);

  // ë°ì´í„° ìˆ˜ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.getElementById('fetchDataBtn').addEventListener('click', async function() {
    const platform = document.getElementById('dataCollectionPlatform').value;
    const btn = this;
    btn.disabled = true;
    btn.textContent = "â³ ìˆ˜ì§‘ ì¤‘...";
    
    try {
      const response = await fetch(`/api/fetch/${platform}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
          start_date: document.getElementById("start_date").value,
          end_date: document.getElementById("end_date").value
        })
      });
      const result = await response.json();
      
      if (result.results) {
        const log = result.results.map(r =>
          `â€¢ ${r.alias} â†’ ${r.status === "success" ? "âœ… ì„±ê³µ" : "âŒ ì‹¤íŒ¨ (" + r.message + ")"}`
        ).join("\n");
        alert(`${platform} ìˆ˜ì§‘ ê²°ê³¼:\n${log}`);
      }
    } catch (err) {
      alert("âŒ ì˜¤ë¥˜: " + err.message);
    }
    
    btn.disabled = false;
    btn.textContent = "ğŸ”„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°";
    location.reload();
  });

  // Adpost ë°ì´í„° ì—…ë¡œë“œ í•¨ìˆ˜
  async function uploadAdpostExcel() {
    const accountSelect = document.getElementById('adpost_account');
    const fileInput = document.getElementById('adpost_excel');
    
    if (!accountSelect.value) {
      alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (!fileInput.files.length) {
      alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const file = fileInput.files[0];
    const fileExt = file.name.split('.').pop().toLowerCase();
    if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
      alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (ì§€ì›: csv, xlsx, xls)');
      return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('account_id', accountSelect.value);
    
    try {
      const response = await fetch('/api/adpost/upload/', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok) {
        let message = result.message;
        if (result.error_count > 0) {
          message += '\n\nì²˜ë¦¬ ì‹¤íŒ¨í•œ ë°ì´í„°:';
          result.errors.forEach(error => {
            message += '\n' + error;
          });
        }
        alert(message);
        fileInput.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        location.reload();
      } else {
        let errorMessage = result.error || 'ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (result.details) {
          errorMessage += '\n\nìƒì„¸ ì˜¤ë¥˜:';
          result.details.forEach(detail => {
            errorMessage += '\n' + detail;
          });
        }
        alert(errorMessage);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('ë°ì´í„° ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
  async function exportToExcel() {
    try {
      // í˜„ì¬ ì„ íƒëœ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
      const startDate = $("start_date").value;
      const endDate = $("end_date").value;
      const platform = $("platformSelector").value;
      const alias = $("accountSelector").value;
      const adUnitId = $("adUnitSelector").value;
      const grouping = $("groupingSelector").value;

      if (!startDate || !endDate) {
        alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì—‘ì…€ìš© ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const response = await fetch(
        `/api/stats/excel/?start_date=${startDate}&end_date=${endDate}&platform=${platform}&alias=${alias}&ad_unit_id=${adUnitId}&grouping=${grouping}`
      );
      
      if (!response.ok) {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
      }

      const data = await response.json();
      if (!Array.isArray(data)) {
        throw new Error('ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
      }

      // ì›Œí¬ë¶ ìƒì„±
      const wb = XLSX.utils.book_new();
      
      // ë°ì´í„° ì¤€ë¹„
      const headers = ['ë‚ ì§œ', 'í”Œë«í¼', 'ê³„ì •', 'ê´‘ê³  ë‹¨ìœ„', 'ìˆ˜ìµ', 'í´ë¦­ ìˆ˜', 'ê´‘ê³  ìš”ì²­ ìˆ˜', 'ì£¼ë¬¸ê±´ìˆ˜', 'í•©ì‚°ê¸ˆì•¡', 'CTR (%)', 'PPC'];
      const excelData = [headers];

      // ë°ì´í„° ê·¸ë£¹í•‘
      const groupedData = {};
      data.forEach(stat => {
        // ë‚ ì§œ í¬ë§·íŒ…
        const date = new Date(stat.date);
        const dateKey = grouping === "month" ? 
          `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : 
          stat.date;
        
        // ê·¸ë£¹ í‚¤ ìƒì„±
        const groupKey = `${dateKey}|${stat.platform}|${stat.alias}|${stat.ad_unit}`;
        
        if (!groupedData[groupKey]) {
          groupedData[groupKey] = {
            date: dateKey,
            platform: stat.platform || '',
            alias: stat.alias || '',
            ad_unit: stat.ad_unit || '',
            earnings: 0,
            clicks: 0,
            impressions: 0,
            order_count: 0,
            total_amount: 0
          };
        }
        
        // ë°ì´í„° ëˆ„ì 
        groupedData[groupKey].earnings += parseFloat(stat.earnings || 0);
        groupedData[groupKey].clicks += parseInt(stat.clicks || 0);
        groupedData[groupKey].impressions += parseInt(stat.impressions || 0);
        groupedData[groupKey].order_count += parseInt(stat.order_count || 0);
        groupedData[groupKey].total_amount += parseFloat(stat.total_amount || 0);
      });

      // ê·¸ë£¹í™”ëœ ë°ì´í„°ë¥¼ ì—‘ì…€ ë°ì´í„°ë¡œ ë³€í™˜
      Object.values(groupedData).forEach(stats => {
        const ctr = stats.impressions > 0 ? (stats.clicks / stats.impressions * 100) : 0;
        const ppc = stats.clicks > 0 ? stats.earnings / stats.clicks : 0;

        excelData.push([
          stats.date,
          stats.platform,
          stats.alias,
          stats.ad_unit,
          stats.earnings,
          stats.clicks,
          stats.impressions,
          stats.order_count,
          stats.total_amount,
          ctr,
          ppc
        ]);
      });

      // í•©ê³„ ê³„ì‚°
      const totals = {
        earnings: 0,
        clicks: 0,
        impressions: 0,
        order_count: 0,
        total_amount: 0
      };

      Object.values(groupedData).forEach(stats => {
        totals.earnings += stats.earnings;
        totals.clicks += stats.clicks;
        totals.impressions += stats.impressions;
        totals.order_count += stats.order_count;
        totals.total_amount += stats.total_amount;
      });

      // í•©ê³„ í–‰ ì¶”ê°€
      const totalCtr = totals.impressions > 0 ? (totals.clicks / totals.impressions * 100) : 0;
      const totalPpc = totals.clicks > 0 ? (totals.earnings / totals.clicks) : 0;

      excelData.push([
        'í•©ê³„/í‰ê· ',
        '',
        '',
        '',
        totals.earnings,
        totals.clicks,
        totals.impressions,
        totals.order_count,
        totals.total_amount,
        totalCtr,
        totalPpc
      ]);

      // ì›Œí¬ì‹œíŠ¸ ìƒì„±
      const ws = XLSX.utils.aoa_to_sheet(excelData);

      // ì—´ ë„ˆë¹„ ì„¤ì •
      const colWidths = [
        { wch: 12 }, // ë‚ ì§œ
        { wch: 10 }, // í”Œë«í¼
        { wch: 15 }, // ê³„ì •
        { wch: 30 }, // ê´‘ê³  ë‹¨ìœ„
        { wch: 12 }, // ìˆ˜ìµ
        { wch: 10 }, // í´ë¦­ ìˆ˜
        { wch: 15 }, // ê´‘ê³  ìš”ì²­ ìˆ˜
        { wch: 15 }, // ì£¼ë¬¸ê±´ìˆ˜
        { wch: 15 }, // í•©ì‚°ê¸ˆì•¡
        { wch: 10 }, // CTR
        { wch: 12 }  // PPC
      ];
      ws['!cols'] = colWidths;

      // ìˆ«ì ì…€ì— ì²œ ë‹¨ìœ„ êµ¬ë¶„ ìŠ¤íƒ€ì¼ ì ìš©
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let row = 1; row <= range.e.r; row++) {
        for (let col = 4; col <= 10; col++) {
          const cell = XLSX.utils.encode_cell({ r: row, c: col });
          if (ws[cell] && typeof ws[cell].v === 'number') {
            ws[cell].t = 'n'; // ìˆ«ì íƒ€ì…ìœ¼ë¡œ ì„¤ì •
            
            // ì»¬ëŸ¼ë³„ë¡œ ë‹¤ë¥¸ ìˆ«ì í¬ë§· ì ìš©
            if (col === 4 || col === 8) { // ìˆ˜ìµ, í•©ì‚°ê¸ˆì•¡
              ws[cell].z = '#,##0.00';
            } else if (col === 5 || col === 6 || col === 7) { // í´ë¦­ ìˆ˜, ê´‘ê³  ìš”ì²­ ìˆ˜, ì£¼ë¬¸ê±´ìˆ˜
              ws[cell].z = '#,##0';
            } else if (col === 9 || col === 10) { // CTR, PPC
              ws[cell].z = '#,##0.00';
            }
          }
        }
      }

      // í•©ê³„ í–‰ ìŠ¤íƒ€ì¼ ì„¤ì •
      const lastRow = excelData.length;
      range.e.r = lastRow - 1;
      ws['!ref'] = XLSX.utils.encode_range(range);

      // í•©ê³„ í–‰ì— êµµì€ ê¸€ì”¨ ìŠ¤íƒ€ì¼ ì ìš©
      for (let col = 0; col < headers.length; col++) {
        const cell = XLSX.utils.encode_cell({ r: lastRow - 1, c: col });
        if (!ws[cell]) ws[cell] = { t: 's' };
        ws[cell].s = { font: { bold: true } };
      }

      // ì›Œí¬ë¶ì— ì›Œí¬ì‹œíŠ¸ ì¶”ê°€
      XLSX.utils.book_append_sheet(wb, ws, "ë°ì´í„°");

      // íŒŒì¼ ì €ì¥
      const fileName = `ê´‘ê³ í†µê³„_${startDate}_${endDate}.xlsx`;
      XLSX.writeFile(wb, fileName);

    } catch (error) {
      console.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
      alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }
</script>

<style>
.table-responsive {
  max-height: 800px;
  overflow-y: auto;
  position: relative;
}

.table th {
  position: sticky;
  top: 0;
  background-color: #f8f9fa;
  z-index: 1;
}

.sortable {
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 20px;
}

.sortable:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.sort-icon {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
}

@media (prefers-color-scheme: dark) {
  .table {
    color: #fff;
  }
  .table th {
    background-color: #f8f9fa;
    color: #000;
  }
  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, 0.05);
  }
  .table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.075);
  }
  .sortable:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
}

#resetSortBtn, #exportExcelBtn {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  color: #000;
  border-color: #6c757d;
}

#resetSortBtn:hover, #exportExcelBtn:hover {
  background-color: #6c757d;
  border-color: #6c757d;
  color: #fff;
}

#exportExcelBtn {
  background-color: #28a745;
  border-color: #28a745;
  color: #fff;
}

#exportExcelBtn:hover {
  background-color: #218838;
  border-color: #1e7e34;
  color: #fff;
}

@media (prefers-color-scheme: dark) {
  #resetSortBtn, #exportExcelBtn {
    color: #000;
    border-color: #6c757d;
  }
  
  #resetSortBtn:hover, #exportExcelBtn:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: #fff;
  }

  #exportExcelBtn {
    background-color: #28a745;
    border-color: #28a745;
    color: #fff;
  }

  #exportExcelBtn:hover {
    background-color: #218838;
    border-color: #1e7e34;
    color: #fff;
  }
}

.form-select-sm {
  height: calc(1.5em + 0.5rem + 2px);
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  border-radius: 0.2rem;
  background-color: #fff;
  border-color: #ced4da;
  color: #212529;
}

.form-control-sm {
  height: calc(1.5em + 0.5rem + 2px);
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  border-radius: 0.2rem;
  background-color: #fff;
  border-color: #ced4da;
  color: #212529;
}

.form-select-sm:focus,
.form-control-sm:focus {
  background-color: #fff;
  border-color: #86b7fe;
  color: #212529;
  outline: 0;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  border-radius: 0.2rem;
  white-space: nowrap;
}

.d-none {
  display: none !important;
}

.gap-2 {
  gap: 0.5rem !important;
}

@media (prefers-color-scheme: dark) {
  .btn-outline-success {
    color: #28a745;
    border-color: #28a745;
    background-color: transparent;
  }

  .btn-outline-success:hover {
    color: #fff;
    background-color: #28a745;
    border-color: #28a745;
  }

  .btn-primary {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
  }

  .btn-primary:hover {
    color: #fff;
    background-color: #0069d9;
    border-color: #0062cc;
  }
}
</style>

{% endblock %}
