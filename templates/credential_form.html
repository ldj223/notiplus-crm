{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}API 수정{% else %}새 API 등록{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">{% if form.instance.pk %}API 수정{% else %}새 API 등록{% endif %}</h2>
    <a href="{% url 'credential_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>목록으로
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.platform.label_tag }}
          {{ form.platform }}
        </div>
        <div class="mb-3" id="div_id_alias">
          {{ form.alias.label_tag }}
          {{ form.alias }}
          {% if form.instance.pk %}
            <small class="text-muted">※ 별칭은 수정할 수 없습니다.</small>
          {% endif %}
        </div>
        <div class="mb-3" id="div_id_client_id">
          {{ form.client_id.label_tag }}
          {{ form.client_id }}
        </div>
        <div class="mb-3" id="div_id_secret">
          {{ form.secret.label_tag }}
          {{ form.secret }}
        </div>
        <div class="mb-3" id="div_id_email">
          {{ form.email.label_tag }}
          {{ form.email }}
        </div>
        <div class="mb-3" id="div_id_password">
          {{ form.password.label_tag }}
          {{ form.password }}
        </div>

        <!-- 쿠팡 계정 분류 필드 -->
        <div class="mb-3" id="div_id_coupang_classification" style="display: none;">
          {{ form.coupang_classification.label_tag }}
          {{ form.coupang_classification }}
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'credential_list' %}" class="btn btn-outline-secondary">취소</a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>저장
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ✅ 애드센스 인증 박스 -->
  <div id="adsense-auth-box" class="mt-4 d-none">
    {% if cred_pk %}
      <a href="#" id="startAdsenseAuth" class="btn btn-warning" target="_blank">🔐 애드센스 인증</a>
    {% else %}
      <span class="text-muted">※ 저장 후 인증 버튼이 활성화됩니다.</span>
    {% endif %}
    <span id="auth-status" class="ms-3 text-muted">※ 인증 상태 확인 중...</span>
  </div>

  <!-- ✅ 애드매니저 인증 박스 -->
  <div id="admanager-auth-box" class="mt-4 d-none">
    {% if cred_pk %}
      <a href="#" id="startAdmanagerAuth" class="btn btn-warning" target="_blank">🔐 애드매니저 인증</a>
    {% else %}
      <span class="text-muted">※ 저장 후 인증 버튼이 활성화됩니다.</span>
    {% endif %}
    <span id="admanager-auth-status" class="ms-3 text-muted">※ 인증 상태 확인 중...</span>

    <!-- 리포트 선택 UI -->
    <div id="admanager-report-box" class="mt-3 d-none">
      <div class="d-flex align-items-center mb-2">
        <h5 class="mb-0">📊 리포트 선택</h5>
        <button id="refreshReports" class="btn btn-sm btn-outline-secondary ms-2">
          <i class="bi bi-arrow-clockwise"></i> 새로고침
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="reportsTable">
          <thead>
            <tr>
              <th>리포트 이름</th>
              <th>유형</th>
              <th>상태</th>
              <th>생성일</th>
              <th>선택</th>
            </tr>
          </thead>
          <tbody>
            <!-- 리포트 목록이 여기에 동적으로 추가됩니다 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ✅ 저장된 자격정보 목록 -->
  {% if user_credentials %}
  <hr>
  <h4>🔐 저장된 자격정보</h4>
  <ul class="list-group">
    {% for cred in user_credentials %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ cred.alias|default:"(기본)" }}</strong>
          <br><small class="text-muted">{{ cred.platform }}</small>
          {% if cred.platform == "adsense" %}
            {% if cred.token %}
              <span class="badge bg-success ms-2">✅ 인증됨</span>
            {% else %}
              <span class="badge bg-danger ms-2">❌ 미인증</span>
            {% endif %}
          {% elif cred.platform == "admanager" %}
            {% if cred.token %}
              <span class="badge bg-success ms-2">✅ 인증됨</span>
            {% else %}
              <span class="badge bg-danger ms-2">❌ 미인증</span>
            {% endif %}
          {% endif %}
        </div>
        <div>
          <a href="{% url 'edit_credential' cred.pk %}" class="btn btn-sm btn-outline-primary">수정</a>
          <a href="{% url 'delete_credential' cred.pk %}" class="btn btn-sm btn-outline-danger"
            onclick="return confirm('정말 삭제하시겠습니까?');">삭제</a>
        </div>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<!-- ✅ 플랫폼 선택에 따른 입력 필드 전환 & 인증 처리 -->
<script>
  const adsenseAuthenticated = {{ is_authenticated|yesno:"true,false" }};
  const admanagerAuthenticated = {{ is_authenticated|yesno:"true,false" }};

  function updateFields() {
    const platform = document.getElementById("id_platform").value;
    const adsenseAuthBox = document.getElementById("adsense-auth-box");
    const admanagerAuthBox = document.getElementById("admanager-auth-box");
    const statusSpan = document.getElementById("auth-status");
    const admanagerStatusSpan = document.getElementById("admanager-auth-status");

    const allFields = ["client_id", "secret", "email", "password"];
    const fieldMap = {
      "adsense": ["client_id", "secret"],
      "admanager": ["client_id", "secret"],
      "coupang": ["client_id", "secret"],
      "adpost": ["email", "password"],
      "cozymamang": ["email", "password"],  // email 필드를 username으로 사용
      "mediamixer": ["email", "password"],  // email 필드를 username으로 사용
      "teads": ["email", "password"],
      "aceplanet": ["client_id"],
      "taboola": ["email", "password"]
    };

    allFields.forEach(field => {
      const fieldDiv = document.getElementById("div_id_" + field);
      if (fieldDiv) {
        fieldDiv.style.display = fieldMap[platform]?.includes(field) ? "block" : "none";
        
        // cozymamang 플랫폼일 때 email 필드의 라벨을 변경
        if ((platform === "cozymamang" || platform === "mediamixer") && field === "email") {
          const label = fieldDiv.querySelector("label");
          if (label) {
            label.textContent = "아이디";
          }
        }
      }
    });

    // 쿠팡 분류 필드 표시/숨김 처리
    const coupangClassificationDiv = document.getElementById("div_id_coupang_classification");
    if (coupangClassificationDiv) {
      coupangClassificationDiv.style.display = platform === "coupang" ? "block" : "none";
    }

    // ✅ 인증 박스 표시/숨김
    if (platform === "adsense") {
      adsenseAuthBox.classList.remove("d-none");
      admanagerAuthBox.classList.add("d-none");

      if (adsenseAuthenticated === true || adsenseAuthenticated === "true") {
        statusSpan.textContent = "✅ 인증되었습니다";
        statusSpan.classList.remove("text-danger", "text-muted");
        statusSpan.classList.add("text-success");
      } else {
        statusSpan.textContent = "❌ 인증이 필요합니다";
        statusSpan.classList.remove("text-success", "text-muted");
        statusSpan.classList.add("text-danger");
      }
    } else if (platform === "admanager") {
      adsenseAuthBox.classList.add("d-none");
      admanagerAuthBox.classList.remove("d-none");

      if (admanagerAuthenticated === true || admanagerAuthenticated === "true") {
        admanagerStatusSpan.textContent = "✅ 인증되었습니다";
        admanagerStatusSpan.classList.remove("text-danger", "text-muted");
        admanagerStatusSpan.classList.add("text-success");
      } else {
        admanagerStatusSpan.textContent = "❌ 인증이 필요합니다";
        admanagerStatusSpan.classList.remove("text-success", "text-muted");
        admanagerStatusSpan.classList.add("text-danger");
      }
    } else {
      adsenseAuthBox.classList.add("d-none");
      admanagerAuthBox.classList.add("d-none");
    }
  }

  document.addEventListener("DOMContentLoaded", updateFields);
  document.getElementById("id_platform").addEventListener("change", updateFields);

  // ✅ AdSense 인증 버튼 클릭 시 새 창 열기
  const adsenseAuthBtn = document.getElementById("startAdsenseAuth");
  if (adsenseAuthBtn) {
    adsenseAuthBtn.addEventListener("click", function (e) {
      e.preventDefault();

      const pk = "{{ cred_pk }}";
      const clientId = document.getElementById("id_client_id").value;
      const clientSecret = document.getElementById("id_secret").value;

      if (!clientId || !clientSecret) {
        alert("클라이언트 ID와 시크릿을 먼저 입력해주세요.");
        return;
      }

      const params = new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        cred_id: pk
      });

      window.open("/credentials/adsense/auth/?" + params.toString(), "_blank", "width=500,height=700");
    });
  }

  // ✅ AdManager 인증 버튼 클릭 시 새 창 열기
  const admanagerAuthBtn = document.getElementById("startAdmanagerAuth");
  if (admanagerAuthBtn) {
    admanagerAuthBtn.addEventListener("click", function (e) {
      e.preventDefault();

      const pk = "{{ cred_pk }}";
      const clientId = document.getElementById("id_client_id").value;
      const clientSecret = document.getElementById("id_secret").value;

      if (!clientId || !clientSecret) {
        alert("클라이언트 ID와 시크릿을 먼저 입력해주세요.");
        return;
      }

      const params = new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        cred_id: pk
      });

      window.open("/credentials/admanager/auth/?" + params.toString(), "_blank", "width=500,height=700");
    });
  }

  // ✅ 인증 성공 메시지 수신
  window.addEventListener("message", function(event) {
    if (event.data === "adsense-auth-success") {
      alert("✅ 애드센스 인증이 완료되었습니다.");
      location.reload();
    } else if (event.data === "adsense-auth-failed") {
      alert("❌ 애드센스 인증 실패: 잘못된 client_id 또는 secret입니다.");
    } else if (event.data === "adsense-auth-error") {
      alert("⚠️ 인증 도중 예기치 못한 오류가 발생했습니다.");
    } else if (event.data === "admanager-auth-success") {
      alert("✅ 애드매니저 인증이 완료되었습니다.");
      location.reload();
    } else if (event.data === "admanager-auth-failed") {
      alert("❌ 애드매니저 인증 실패: 잘못된 client_id 또는 secret입니다.");
    } else if (event.data === "admanager-auth-error") {
      alert("⚠️ 인증 도중 예기치 못한 오류가 발생했습니다.");
    }
  });

  // ✅ AdManager 인증 후 리포트 목록 불러오기 및 선택 저장
  function loadAdmanagerReports() {
    const pk = "{{ cred_pk }}";
    const alias = document.getElementById("id_alias")?.value;
    if (!alias) return;

    // 먼저 현재 저장된 보고서 정보를 가져오기
    fetch(`/api/admanager/reports/?alias=${encodeURIComponent(alias)}`)
      .then(res => res.json())
      .then(data => {
        if (data.status !== "success") {
          alert("보고서 목록을 불러올 수 없습니다: " + data.message);
          return;
        }
        
        // 현재 저장된 보고서 정보도 함께 가져오기
        return fetch(`/api/admanager/current-report/?alias=${encodeURIComponent(alias)}`)
          .then(res => res.json())
          .then(currentData => {
            const currentReportId = currentData.report_id || '';
            
            const box = document.getElementById("admanager-report-box");
            box.classList.remove("d-none");
            const tbody = document.querySelector("#reportsTable tbody");
            tbody.innerHTML = "";
            
            data.reports.forEach(report => {
              const isSelected = report.id === currentReportId;
              const tr = document.createElement("tr");
              if (isSelected) {
                tr.classList.add("table-success");
              }
              tr.innerHTML = `
                <td>
                  ${report.name}
                  ${isSelected ? '<span class="badge bg-success ms-2">선택됨</span>' : ''}
                </td>
                <td>${report.type || ''}</td>
                <td>${report.status}</td>
                <td>${report.created_at || ''}</td>
                <td>
                  ${isSelected 
                    ? '<button class="btn btn-sm btn-success" disabled data-report-id="' + report.id + '">선택됨</button>'
                    : '<button class="btn btn-sm btn-primary select-report-btn" data-report-id="' + report.id + '">선택</button>'
                  }
                </td>
              `;
              tbody.appendChild(tr);
            });
          });
      })
      .catch(error => {
        console.error('보고서 목록 로딩 실패:', error);
        alert("보고서 목록을 불러올 수 없습니다.");
      });
  }

  // 리포트 선택 버튼 이벤트 위임
  if (document.getElementById("admanager-report-box")) {
    document.getElementById("admanager-report-box").addEventListener("click", function(e) {
      if (e.target.classList.contains("select-report-btn")) {
        const reportId = e.target.getAttribute("data-report-id");
        const alias = document.getElementById("id_alias")?.value;
        if (!alias || !reportId) return;
        
        // 버튼을 로딩 상태로 변경
        e.target.disabled = true;
        e.target.innerHTML = '<i class="bi bi-hourglass-split"></i> 저장 중...';
        
        fetch("/api/admanager/save-report/", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ alias: alias, report_id: reportId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            // 성공 시 UI 업데이트
            const tr = e.target.closest('tr');
            
            // 모든 행의 선택 상태 초기화
            document.querySelectorAll('#reportsTable tbody tr').forEach(row => {
              row.classList.remove("table-success");
              const nameCell = row.querySelector('td:first-child');
              const badge = nameCell.querySelector('.badge');
              if (badge) {
                badge.remove();
              }
              const btn = row.querySelector('button');
              if (btn) {
                // 버튼을 완전히 새로 생성
                const reportId = btn.getAttribute('data-report-id') || btn.getAttribute('data-original-report-id');
                if (reportId) {
                  const newBtn = document.createElement('button');
                  newBtn.className = 'btn btn-sm btn-primary select-report-btn';
                  newBtn.setAttribute('data-report-id', reportId);
                  newBtn.innerHTML = '선택';
                  btn.parentNode.replaceChild(newBtn, btn);
                }
              }
            });
            
            // 새로 선택된 행만 하이라이트
            tr.classList.add("table-success");
            
            // 선택된 행의 버튼을 "선택됨" 상태로 변경
            const selectedBtn = tr.querySelector('button');
            if (selectedBtn) {
              selectedBtn.disabled = true;
              selectedBtn.innerHTML = '선택됨';
              selectedBtn.classList.remove('btn-primary', 'select-report-btn');
              selectedBtn.classList.add('btn-success');
            }
            
            // 보고서 이름에 "선택됨" 배지 추가
            const nameCell = tr.querySelector('td:first-child');
            if (!nameCell.querySelector('.badge')) {
              nameCell.innerHTML += '<span class="badge bg-success ms-2">선택됨</span>';
            }
            
            alert("✅ 보고서가 저장되었습니다!");
          } else {
            // 실패 시 버튼 복원
            e.target.disabled = false;
            e.target.innerHTML = '선택';
            alert("❌ 저장 실패: " + data.message);
          }
        })
        .catch(error => {
          // 에러 시 버튼 복원
          e.target.disabled = false;
          e.target.innerHTML = '선택';
          alert("❌ 저장 중 오류가 발생했습니다.");
        });
      }
    });
  }

  // 인증이 완료되면 자동으로 리포트 목록 불러오기
  function tryShowAdmanagerReports() {
    const platform = document.getElementById("id_platform").value;
    const admanagerAuthBox = document.getElementById("admanager-auth-box");
    const admanagerAuthenticated = {{ is_authenticated|yesno:"true,false" }};
    if (platform === "admanager" && admanagerAuthBox && (admanagerAuthenticated === true || admanagerAuthenticated === "true")) {
      loadAdmanagerReports();
    }
  }
  document.addEventListener("DOMContentLoaded", tryShowAdmanagerReports);

  // 새로고침 버튼
  const refreshBtn = document.getElementById("refreshReports");
  if (refreshBtn) {
    refreshBtn.addEventListener("click", function(e) {
      e.preventDefault();
      loadAdmanagerReports();
    });
  }
</script>
{% endblock %}