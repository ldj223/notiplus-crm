{% extends "base.html" %}
{% block title %}{% if form.instance.pk %}API ìˆ˜ì •{% else %}ìƒˆ API ë“±ë¡{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">{% if form.instance.pk %}API ìˆ˜ì •{% else %}ìƒˆ API ë“±ë¡{% endif %}</h2>
    <a href="{% url 'credential_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.platform.label_tag }}
          {{ form.platform }}
        </div>
        <div class="mb-3" id="div_id_alias">
          {{ form.alias.label_tag }}
          {{ form.alias }}
          {% if form.instance.pk %}
            <small class="text-muted">â€» ë³„ì¹­ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
          {% endif %}
        </div>
        <div class="mb-3" id="div_id_client_id">
          {{ form.client_id.label_tag }}
          {{ form.client_id }}
        </div>
        <div class="mb-3" id="div_id_secret">
          {{ form.secret.label_tag }}
          {{ form.secret }}
        </div>
        <div class="mb-3" id="div_id_email">
          {{ form.email.label_tag }}
          {{ form.email }}
        </div>
        <div class="mb-3" id="div_id_password">
          {{ form.password.label_tag }}
          {{ form.password }}
        </div>

        <!-- ì¿ íŒ¡ ê³„ì • ë¶„ë¥˜ í•„ë“œ -->
        <div class="mb-3" id="div_id_coupang_classification" style="display: none;">
          {{ form.coupang_classification.label_tag }}
          {{ form.coupang_classification }}
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'credential_list' %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>ì €ì¥
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- âœ… ì• ë“œì„¼ìŠ¤ ì¸ì¦ ë°•ìŠ¤ -->
  <div id="adsense-auth-box" class="mt-4 d-none">
    {% if cred_pk %}
      <a href="#" id="startAdsenseAuth" class="btn btn-warning" target="_blank">ğŸ” ì• ë“œì„¼ìŠ¤ ì¸ì¦</a>
    {% else %}
      <span class="text-muted">â€» ì €ì¥ í›„ ì¸ì¦ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</span>
    {% endif %}
    <span id="auth-status" class="ms-3 text-muted">â€» ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...</span>
  </div>

  <!-- âœ… ì• ë“œë§¤ë‹ˆì € ì¸ì¦ ë°•ìŠ¤ -->
  <div id="admanager-auth-box" class="mt-4 d-none">
    {% if cred_pk %}
      <a href="#" id="startAdmanagerAuth" class="btn btn-warning" target="_blank">ğŸ” ì• ë“œë§¤ë‹ˆì € ì¸ì¦</a>
    {% else %}
      <span class="text-muted">â€» ì €ì¥ í›„ ì¸ì¦ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</span>
    {% endif %}
    <span id="admanager-auth-status" class="ms-3 text-muted">â€» ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...</span>

    <!-- ë¦¬í¬íŠ¸ ì„ íƒ UI -->
    <div id="admanager-report-box" class="mt-3 d-none">
      <div class="d-flex align-items-center mb-2">
        <h5 class="mb-0">ğŸ“Š ë¦¬í¬íŠ¸ ì„ íƒ</h5>
        <button id="refreshReports" class="btn btn-sm btn-outline-secondary ms-2">
          <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover" id="reportsTable">
          <thead>
            <tr>
              <th>ë¦¬í¬íŠ¸ ì´ë¦„</th>
              <th>ìœ í˜•</th>
              <th>ìƒíƒœ</th>
              <th>ìƒì„±ì¼</th>
              <th>ì„ íƒ</th>
            </tr>
          </thead>
          <tbody>
            <!-- ë¦¬í¬íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- âœ… ì €ì¥ëœ ìê²©ì •ë³´ ëª©ë¡ -->
  {% if user_credentials %}
  <hr>
  <h4>ğŸ” ì €ì¥ëœ ìê²©ì •ë³´</h4>
  <ul class="list-group">
    {% for cred in user_credentials %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ cred.alias|default:"(ê¸°ë³¸)" }}</strong>
          <br><small class="text-muted">{{ cred.platform }}</small>
          {% if cred.platform == "adsense" %}
            {% if cred.token %}
              <span class="badge bg-success ms-2">âœ… ì¸ì¦ë¨</span>
            {% else %}
              <span class="badge bg-danger ms-2">âŒ ë¯¸ì¸ì¦</span>
            {% endif %}
          {% elif cred.platform == "admanager" %}
            {% if cred.token %}
              <span class="badge bg-success ms-2">âœ… ì¸ì¦ë¨</span>
            {% else %}
              <span class="badge bg-danger ms-2">âŒ ë¯¸ì¸ì¦</span>
            {% endif %}
          {% endif %}
        </div>
        <div>
          <a href="{% url 'edit_credential' cred.pk %}" class="btn btn-sm btn-outline-primary">ìˆ˜ì •</a>
          <a href="{% url 'delete_credential' cred.pk %}" class="btn btn-sm btn-outline-danger"
            onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
        </div>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<!-- âœ… í”Œë«í¼ ì„ íƒì— ë”°ë¥¸ ì…ë ¥ í•„ë“œ ì „í™˜ & ì¸ì¦ ì²˜ë¦¬ -->
<script>
  const adsenseAuthenticated = {{ is_authenticated|yesno:"true,false" }};
  const admanagerAuthenticated = {{ is_authenticated|yesno:"true,false" }};

  function updateFields() {
    const platform = document.getElementById("id_platform").value;
    const adsenseAuthBox = document.getElementById("adsense-auth-box");
    const admanagerAuthBox = document.getElementById("admanager-auth-box");
    const statusSpan = document.getElementById("auth-status");
    const admanagerStatusSpan = document.getElementById("admanager-auth-status");

    const allFields = ["client_id", "secret", "email", "password"];
    const fieldMap = {
      "adsense": ["client_id", "secret"],
      "admanager": ["client_id", "secret"],
      "coupang": ["client_id", "secret"],
      "adpost": ["email", "password"],
      "cozymamang": ["email", "password"],  // email í•„ë“œë¥¼ usernameìœ¼ë¡œ ì‚¬ìš©
      "mediamixer": ["email", "password"],  // email í•„ë“œë¥¼ usernameìœ¼ë¡œ ì‚¬ìš©
      "teads": ["email", "password"],
      "aceplanet": ["client_id"],
      "taboola": ["email", "password"]
    };

    allFields.forEach(field => {
      const fieldDiv = document.getElementById("div_id_" + field);
      if (fieldDiv) {
        fieldDiv.style.display = fieldMap[platform]?.includes(field) ? "block" : "none";
        
        // cozymamang í”Œë«í¼ì¼ ë•Œ email í•„ë“œì˜ ë¼ë²¨ì„ ë³€ê²½
        if ((platform === "cozymamang" || platform === "mediamixer") && field === "email") {
          const label = fieldDiv.querySelector("label");
          if (label) {
            label.textContent = "ì•„ì´ë””";
          }
        }
      }
    });

    // ì¿ íŒ¡ ë¶„ë¥˜ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
    const coupangClassificationDiv = document.getElementById("div_id_coupang_classification");
    if (coupangClassificationDiv) {
      coupangClassificationDiv.style.display = platform === "coupang" ? "block" : "none";
    }

    // âœ… ì¸ì¦ ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€
    if (platform === "adsense") {
      adsenseAuthBox.classList.remove("d-none");
      admanagerAuthBox.classList.add("d-none");

      if (adsenseAuthenticated === true || adsenseAuthenticated === "true") {
        statusSpan.textContent = "âœ… ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤";
        statusSpan.classList.remove("text-danger", "text-muted");
        statusSpan.classList.add("text-success");
      } else {
        statusSpan.textContent = "âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤";
        statusSpan.classList.remove("text-success", "text-muted");
        statusSpan.classList.add("text-danger");
      }
    } else if (platform === "admanager") {
      adsenseAuthBox.classList.add("d-none");
      admanagerAuthBox.classList.remove("d-none");

      if (admanagerAuthenticated === true || admanagerAuthenticated === "true") {
        admanagerStatusSpan.textContent = "âœ… ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤";
        admanagerStatusSpan.classList.remove("text-danger", "text-muted");
        admanagerStatusSpan.classList.add("text-success");
      } else {
        admanagerStatusSpan.textContent = "âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤";
        admanagerStatusSpan.classList.remove("text-success", "text-muted");
        admanagerStatusSpan.classList.add("text-danger");
      }
    } else {
      adsenseAuthBox.classList.add("d-none");
      admanagerAuthBox.classList.add("d-none");
    }
  }

  document.addEventListener("DOMContentLoaded", updateFields);
  document.getElementById("id_platform").addEventListener("change", updateFields);

  // âœ… AdSense ì¸ì¦ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ ì°½ ì—´ê¸°
  const adsenseAuthBtn = document.getElementById("startAdsenseAuth");
  if (adsenseAuthBtn) {
    adsenseAuthBtn.addEventListener("click", function (e) {
      e.preventDefault();

      const pk = "{{ cred_pk }}";
      const clientId = document.getElementById("id_client_id").value;
      const clientSecret = document.getElementById("id_secret").value;

      if (!clientId || !clientSecret) {
        alert("í´ë¼ì´ì–¸íŠ¸ IDì™€ ì‹œí¬ë¦¿ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const params = new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        cred_id: pk
      });

      window.open("/credentials/adsense/auth/?" + params.toString(), "_blank", "width=500,height=700");
    });
  }

  // âœ… AdManager ì¸ì¦ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ ì°½ ì—´ê¸°
  const admanagerAuthBtn = document.getElementById("startAdmanagerAuth");
  if (admanagerAuthBtn) {
    admanagerAuthBtn.addEventListener("click", function (e) {
      e.preventDefault();

      const pk = "{{ cred_pk }}";
      const clientId = document.getElementById("id_client_id").value;
      const clientSecret = document.getElementById("id_secret").value;

      if (!clientId || !clientSecret) {
        alert("í´ë¼ì´ì–¸íŠ¸ IDì™€ ì‹œí¬ë¦¿ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      const params = new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        cred_id: pk
      });

      window.open("/credentials/admanager/auth/?" + params.toString(), "_blank", "width=500,height=700");
    });
  }

  // âœ… ì¸ì¦ ì„±ê³µ ë©”ì‹œì§€ ìˆ˜ì‹ 
  window.addEventListener("message", function(event) {
    if (event.data === "adsense-auth-success") {
      alert("âœ… ì• ë“œì„¼ìŠ¤ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } else if (event.data === "adsense-auth-failed") {
      alert("âŒ ì• ë“œì„¼ìŠ¤ ì¸ì¦ ì‹¤íŒ¨: ì˜ëª»ëœ client_id ë˜ëŠ” secretì…ë‹ˆë‹¤.");
    } else if (event.data === "adsense-auth-error") {
      alert("âš ï¸ ì¸ì¦ ë„ì¤‘ ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } else if (event.data === "admanager-auth-success") {
      alert("âœ… ì• ë“œë§¤ë‹ˆì € ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    } else if (event.data === "admanager-auth-failed") {
      alert("âŒ ì• ë“œë§¤ë‹ˆì € ì¸ì¦ ì‹¤íŒ¨: ì˜ëª»ëœ client_id ë˜ëŠ” secretì…ë‹ˆë‹¤.");
    } else if (event.data === "admanager-auth-error") {
      alert("âš ï¸ ì¸ì¦ ë„ì¤‘ ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });

  // âœ… AdManager ì¸ì¦ í›„ ë¦¬í¬íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì„ íƒ ì €ì¥
  function loadAdmanagerReports() {
    const pk = "{{ cred_pk }}";
    const alias = document.getElementById("id_alias")?.value;
    if (!alias) return;

    // ë¨¼ì € í˜„ì¬ ì €ì¥ëœ ë³´ê³ ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
    fetch(`/api/admanager/reports/?alias=${encodeURIComponent(alias)}`)
      .then(res => res.json())
      .then(data => {
        if (data.status !== "success") {
          alert("ë³´ê³ ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + data.message);
          return;
        }
        
        // í˜„ì¬ ì €ì¥ëœ ë³´ê³ ì„œ ì •ë³´ë„ í•¨ê»˜ ê°€ì ¸ì˜¤ê¸°
        return fetch(`/api/admanager/current-report/?alias=${encodeURIComponent(alias)}`)
          .then(res => res.json())
          .then(currentData => {
            const currentReportId = currentData.report_id || '';
            
            const box = document.getElementById("admanager-report-box");
            box.classList.remove("d-none");
            const tbody = document.querySelector("#reportsTable tbody");
            tbody.innerHTML = "";
            
            data.reports.forEach(report => {
              const isSelected = report.id === currentReportId;
              const tr = document.createElement("tr");
              if (isSelected) {
                tr.classList.add("table-success");
              }
              tr.innerHTML = `
                <td>
                  ${report.name}
                  ${isSelected ? '<span class="badge bg-success ms-2">ì„ íƒë¨</span>' : ''}
                </td>
                <td>${report.type || ''}</td>
                <td>${report.status}</td>
                <td>${report.created_at || ''}</td>
                <td>
                  ${isSelected 
                    ? '<button class="btn btn-sm btn-success" disabled data-report-id="' + report.id + '">ì„ íƒë¨</button>'
                    : '<button class="btn btn-sm btn-primary select-report-btn" data-report-id="' + report.id + '">ì„ íƒ</button>'
                  }
                </td>
              `;
              tbody.appendChild(tr);
            });
          });
      })
      .catch(error => {
        console.error('ë³´ê³ ì„œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
        alert("ë³´ê³ ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      });
  }

  // ë¦¬í¬íŠ¸ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
  if (document.getElementById("admanager-report-box")) {
    document.getElementById("admanager-report-box").addEventListener("click", function(e) {
      if (e.target.classList.contains("select-report-btn")) {
        const reportId = e.target.getAttribute("data-report-id");
        const alias = document.getElementById("id_alias")?.value;
        if (!alias || !reportId) return;
        
        // ë²„íŠ¼ì„ ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
        e.target.disabled = true;
        e.target.innerHTML = '<i class="bi bi-hourglass-split"></i> ì €ì¥ ì¤‘...';
        
        fetch("/api/admanager/save-report/", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ alias: alias, report_id: reportId })
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            // ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
            const tr = e.target.closest('tr');
            
            // ëª¨ë“  í–‰ì˜ ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            document.querySelectorAll('#reportsTable tbody tr').forEach(row => {
              row.classList.remove("table-success");
              const nameCell = row.querySelector('td:first-child');
              const badge = nameCell.querySelector('.badge');
              if (badge) {
                badge.remove();
              }
              const btn = row.querySelector('button');
              if (btn) {
                // ë²„íŠ¼ì„ ì™„ì „íˆ ìƒˆë¡œ ìƒì„±
                const reportId = btn.getAttribute('data-report-id') || btn.getAttribute('data-original-report-id');
                if (reportId) {
                  const newBtn = document.createElement('button');
                  newBtn.className = 'btn btn-sm btn-primary select-report-btn';
                  newBtn.setAttribute('data-report-id', reportId);
                  newBtn.innerHTML = 'ì„ íƒ';
                  btn.parentNode.replaceChild(newBtn, btn);
                }
              }
            });
            
            // ìƒˆë¡œ ì„ íƒëœ í–‰ë§Œ í•˜ì´ë¼ì´íŠ¸
            tr.classList.add("table-success");
            
            // ì„ íƒëœ í–‰ì˜ ë²„íŠ¼ì„ "ì„ íƒë¨" ìƒíƒœë¡œ ë³€ê²½
            const selectedBtn = tr.querySelector('button');
            if (selectedBtn) {
              selectedBtn.disabled = true;
              selectedBtn.innerHTML = 'ì„ íƒë¨';
              selectedBtn.classList.remove('btn-primary', 'select-report-btn');
              selectedBtn.classList.add('btn-success');
            }
            
            // ë³´ê³ ì„œ ì´ë¦„ì— "ì„ íƒë¨" ë°°ì§€ ì¶”ê°€
            const nameCell = tr.querySelector('td:first-child');
            if (!nameCell.querySelector('.badge')) {
              nameCell.innerHTML += '<span class="badge bg-success ms-2">ì„ íƒë¨</span>';
            }
            
            alert("âœ… ë³´ê³ ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          } else {
            // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë³µì›
            e.target.disabled = false;
            e.target.innerHTML = 'ì„ íƒ';
            alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + data.message);
          }
        })
        .catch(error => {
          // ì—ëŸ¬ ì‹œ ë²„íŠ¼ ë³µì›
          e.target.disabled = false;
          e.target.innerHTML = 'ì„ íƒ';
          alert("âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
      }
    });
  }

  // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ë¦¬í¬íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  function tryShowAdmanagerReports() {
    const platform = document.getElementById("id_platform").value;
    const admanagerAuthBox = document.getElementById("admanager-auth-box");
    const admanagerAuthenticated = {{ is_authenticated|yesno:"true,false" }};
    if (platform === "admanager" && admanagerAuthBox && (admanagerAuthenticated === true || admanagerAuthenticated === "true")) {
      loadAdmanagerReports();
    }
  }
  document.addEventListener("DOMContentLoaded", tryShowAdmanagerReports);

  // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
  const refreshBtn = document.getElementById("refreshReports");
  if (refreshBtn) {
    refreshBtn.addEventListener("click", function(e) {
      e.preventDefault();
      loadAdmanagerReports();
    });
  }
</script>
{% endblock %}