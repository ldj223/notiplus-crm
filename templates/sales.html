{% extends 'base.html' %}
{% load humanize %}
{% load custom_filters %}
{% block title %}매출 현황{% endblock %}
{% block content %}
<style>
  .table {
    font-size: 0.75rem;
    min-width: 400px;
  }
  .table td, .table th {
    white-space: nowrap;
  }
  @media (max-width: 768px) {
    .table-responsive {
      font-size: 0.7rem;
    }
    .table thead th {
      white-space: nowrap;
    }
    .table td, .table th {
      min-width: 140px;
    }
  }
  [data-bs-theme="dark"] .table {
    color: #e9ecef;
  }
  [data-bs-theme="dark"] .table-bordered {
    border-color: #495057;
  }
  [data-bs-theme="dark"] .table-light {
    background-color: #343a40;
  }
  [data-bs-theme="dark"] .table-light th {
    background-color: #343a40;
    color: #e9ecef;
  }
  [data-bs-theme="dark"] .bg-light {
    background-color: #343a40 !important;
    color: #e9ecef !important;
  }
  [data-bs-theme="dark"] .text-muted {
    color: #adb5bd !important;
  }
  .table thead th {
      vertical-align: middle !important;
      padding: 0.5rem;
      text-align: center;
  }
  .section-card {
    background-color: #f8f9fa;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  [data-bs-theme="dark"] .section-card {
    background-color: #343a40;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
  }
  .section-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 1rem;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 0.5rem;
  }
  [data-bs-theme="dark"] .section-title {
    color: #e9ecef;
    border-bottom-color: #495057;
  }
  .total-row {
    background-color: #f8f9fa;
    font-weight: bold;
  }
  [data-bs-theme="dark"] .total-row {
    background-color: #2c3034;
  }
  .highlight {
    background-color: #e6e0f8;
  }
  [data-bs-theme="dark"] .highlight {
    background-color: #4a4267;
  }
  .sub-header {
      font-size: 0.75em;
      font-weight: normal;
      color: #6c757d;
  }
  [data-bs-theme="dark"] .sub-header {
      color: #adb5bd;
  }
  .table th {
      white-space: nowrap;
      vertical-align: middle;
      padding: 0.5rem 0.25rem;
  }
  .table td {
      padding: 0.25rem;
      vertical-align: middle;
  }
  .form-control-sm, .form-select-sm {
      padding: 0.25rem 0.5rem;
      min-height: auto;
      font-size: 0.75rem;
  }
  .form-select-sm option {
      white-space: normal;
      word-wrap: break-word;
  }
  .table-responsive {
      overflow-x: auto;
      max-width: 100%;
  }
  .tooltip-inner {
      max-width: 400px;
      text-align: left;
      font-size: 0.75rem;
      line-height: 1.4;
  }
  .tooltip-inner strong {
      color: #fff;
  }
  .tooltip-inner br {
      margin-bottom: 2px;
  }
  .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
  }
  .department-manage-btn {
      font-size: 0.65rem;
      padding: 0.2rem 0.4rem;
      margin-top: 0.25rem;
  }
  .change-positive {
      color: #198754 !important;
      font-weight: 500;
  }
  .change-negative {
      color: #dc3545 !important;
      font-weight: 500;
  }
  .change-zero {
      color: #6c757d !important;
  }
  [data-bs-theme="dark"] .change-positive {
      color: #75b798 !important;
  }
  [data-bs-theme="dark"] .change-negative {
      color: #ea868f !important;
  }
  [data-bs-theme="dark"] .change-zero {
      color: #adb5bd !important;
  }
  .form-section {
    background-color: #ffffff;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
  }
  [data-bs-theme="dark"] .form-section {
    background-color: #2c3034;
    border-color: #495057;
  }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 fw-bold">매출 현황</h2>
    </div>

    <!-- ===== 섹션 2: 데이터 관리 및 검색 ===== -->
    <div class="section-card">
        <div class="section-title">
            <i class="fas fa-database me-2"></i>데이터 관리 및 검색
        </div>

        <!-- ===== 폼 1: 데이터 관리 ===== -->
        <form method="post" enctype="multipart/form-data" id="excelUploadForm">
            {% csrf_token %}
            <div class="form-section">
                <h5 class="mb-3">데이터 관리</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="year" class="form-label">조회년도</label>
                        <input type="number" class="form-control form-control-sm" id="year" name="year" value="{{ year }}" placeholder="YYYY" min="2000" max="2099" onchange="this.form.method='get'; this.form.submit()">
                    </div>
                    <div class="col-md-4">
                        <label for="excel_file" class="form-label">엑셀 업로드</label>
                        <input type="file" class="form-control form-control-sm" id="excel_file" name="excel_file" accept=".xls, .xlsx" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success btn-sm w-100">
                            <i class="fas fa-upload"></i> 업로드
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'sales_excel_download' %}?year={{ year }}" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-file-excel"></i> 엑셀 다운로드
                        </a>
                    </div>
                </div>
            </div>
        </form>

        <!-- ===== 폼 2: 검색 및 그룹화 ===== -->
        <div class="form-section">
            <h5 class="mb-3">검색 및 그룹화</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="searchText" class="form-label">검색어</label>
                    <input type="text" class="form-control form-control-sm" id="searchText" placeholder="업체명 또는 서비스명에 포함된 텍스트">
                </div>
                <div class="col-md-2">
                    <label for="searchType" class="form-label">검색 범위</label>
                    <select class="form-select form-select-sm" id="searchType">
                        <option value="both">업체명 + 서비스명</option>
                        <option value="company">업체명만</option>
                        <option value="service">서비스명만</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="searchBtn">
                        <i class="fas fa-search"></i> 검색
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="clearSearchBtn">
                        <i class="fas fa-times"></i> 초기화
                    </button>
                </div>
            </div>
            
            <!-- 선택된 항목 관리 -->
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-warning btn-sm" id="ungroupSelectedRows" disabled>
                            <i class="fas fa-ungroup"></i> 선택 그룹 해제
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteSelectedRows" disabled>
                            <i class="fas fa-trash"></i> 선택 삭제
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 검색 결과 표시 -->
            <div class="row mt-3" id="searchResults" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-info py-2">
                        <strong>검색 결과:</strong> <span id="resultCount">0</span>개 항목이 선택되었습니다.
                        <button type="button" class="btn btn-sm btn-outline-info ms-2" id="selectAllSearchResults">전체 선택</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="deselectAllSearchResults">선택 해제</button>
                    </div>
                </div>
            </div>
            
            <!-- 그룹화 기능 -->
            <div class="row mt-3" id="groupingSection" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-success py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <strong style="white-space: nowrap;">그룹화 옵션:</strong>
                                <select class="form-select form-select-sm" id="existingGroupSelect" style="min-width: 200px;">
                                    <option value="">기존 그룹 선택...</option>
                                </select>
                                <button type="button" class="btn btn-success btn-sm" id="addToGroupBtn" disabled style="white-space: nowrap;">
                                    <i class="fas fa-plus"></i> 기존 그룹에 추가
                                </button>
                                <button type="button" class="btn btn-warning btn-sm" id="createNewGroupBtn" disabled style="white-space: nowrap;">
                                    <i class="fas fa-object-group"></i> 새 그룹 생성
                                </button>
                            </div>
                            <small class="text-muted">선택된 항목들을 그룹화할 수 있습니다.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 매출 데이터 테이블 ===== -->
        <form id="mainForm" method="post" enctype="multipart/form-data" onsubmit="return handleFormSubmit(event)">
            {% csrf_token %}
            <div class="table-responsive mb-3">
                <table class="table table-bordered align-middle text-center" style="font-size: 0.75rem;">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2" style="width: 40px;">No.</th>
                            <th style="width: 50px;">
                                <input type="checkbox" class="form-check-input" id="selectAllRows">
                            </th>
                            <th style="width: 80px;">발행유형</th>
                            <th style="width: 80px;">정산시기</th>
                            <th style="width: 120px;">
                                정산주관부서
                                <div>
                                    <button type="button" class="btn btn-outline-primary department-manage-btn" onclick="openDepartmentManagement()">
                                        <i class="fas fa-cog"></i> 관리
                                    </button>
                                </div>
                            </th>
                            <th style="width: 120px;">업체명</th>
                            <th style="width: 120px;">서비스명</th>
                            <th style="width: 100px;">그룹코드</th>
                            <th colspan="{{ months|length|multiply:2 }}" style="width: 20%;">월평균 균등환율(원)</th>
                            <th rowspan="2" style="width: 5%;">총합</th>
                        </tr>
                        <tr>
                            <th style="padding: 0.25rem;">
                                <div class="d-flex flex-column gap-1">
                                    <button type="button" id="applyBulkChanges" class="btn btn-primary btn-sm" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                                        일괄 적용
                                    </button>
                                </div>
                            </th>
                            <th style="padding: 0.25rem;">
                                <select id="bulkIssueType" class="form-select form-select-sm" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                                    <option value="">선택</option>
                                    <option value="정발행">정발행</option>
                                    <option value="역발행">역발행</option>
                                    <option value="영세율">영세율</option>
                                </select>
                            </th>
                            <th style="padding: 0.25rem;">
                                <select id="bulkSettlementPeriod" class="form-select form-select-sm" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                                    <option value="">선택</option>
                                    <option value="익월">익월</option>
                                    <option value="익익월">익익월</option>
                                </select>
                            </th>
                            <th style="padding: 0.25rem;">
                                <select id="bulkSettlementDepartment" class="form-select form-select-sm" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                                    <option value="">선택</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th style="padding: 0.25rem;">
                                <input type="text" id="bulkCompanyName" class="form-control form-control-sm" placeholder="업체명" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                            </th>
                            <th style="padding: 0.25rem;">
                                <input type="text" id="bulkServiceName" class="form-control form-control-sm" placeholder="서비스명" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                            </th>
                            <th style="padding: 0.25rem;">
                                <input type="text" id="bulkGroupCode" class="form-control form-control-sm" placeholder="그룹코드" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                            </th>
                            {% for month in months %}
                            <th style="padding: 0.25rem;">
                                {{ month }}월
                            </th>
                            <th style="padding: 0.25rem;">증감</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in sales_data %}
                        <tr {% if not item.is_group %}class="table-warning"{% endif %} data-is-group="{{ item.is_group|yesno:'true,false' }}">
                            <td class="text-center">
                                {{ forloop.counter }}
                                {% if item.is_group %}
                                    <br><span class="badge bg-primary" style="font-size: 0.6em;">그룹</span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="checkbox" class="form-check-input row-checkbox" value="{{ item.code }}">
                            </td>
                            <td>
                                {% if item.is_group %}
                                    <select name="issue_type_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 100px;">
                                        <option value="">---------</option>
                                        {% for value, display in issue_type_choices %}
                                        <option value="{{ value }}" {% if item.raw_issue_type == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <select name="issue_type_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 100px;" disabled>
                                        <option value="">---------</option>
                                        {% for value, display in issue_type_choices %}
                                        <option value="{{ value }}" {% if item.raw_issue_type == value %}selected{% endif %}>{{ display }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.is_group %}
                                    <select name="settlement_period_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 100px;">
                                        <option value="">---------</option>
                                        <option value="익월" {% if item.settlement_timing == '익월' %}selected{% endif %}>익월</option>
                                        <option value="익익월" {% if item.settlement_timing == '익익월' %}selected{% endif %}>익익월</option>
                                    </select>
                                {% else %}
                                    <select name="settlement_period_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 100px;" disabled>
                                        <option value="">---------</option>
                                        <option value="익월" {% if item.settlement_timing == '익월' %}selected{% endif %}>익월</option>
                                        <option value="익익월" {% if item.settlement_timing == '익익월' %}selected{% endif %}>익익월</option>
                                    </select>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.is_group %}
                                    <select name="settlement_department_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 120px;">
                                        <option value="">---------</option>
                                        {% for dept in departments %}
                                        <option value="{{ dept.id }}" {% if item.raw_department_id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <select name="settlement_department_{{ item.code }}" class="form-select form-select-sm" style="font-size: 0.7rem; min-width: 120px;" disabled>
                                        <option value="">---------</option>
                                        {% for dept in departments %}
                                        <option value="{{ dept.id }}" {% if item.raw_department_id == dept.id %}selected{% endif %}>{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </td>
                            <td>
                                <input type="text" 
                                       name="company_name_{{ item.code }}" 
                                       value="{{ item.company_name }}" 
                                       class="form-control form-control-sm" 
                                       style="font-size: 0.7rem; min-width: 120px;">
                            </td>
                            <td>
                                <input type="text" 
                                       name="service_name_{{ item.code }}" 
                                       value="{{ item.service_name }}" 
                                       class="form-control form-control-sm" 
                                       style="font-size: 0.7rem; min-width: 120px;">
                                {% if item.is_group %}
                                    {% if item.service_names_list|length > 1 %}
                                        <small class="text-info d-block" style="font-size: 0.6rem; cursor: pointer;" 
                                               data-bs-toggle="tooltip" 
                                               data-bs-html="true"
                                               title="<strong>전체 서비스 정보:</strong><br>{% for name in item.service_names_list %}<strong>{{ name }}</strong><br>{% for code in item.service_mapping|get_item:name %}&nbsp;&nbsp;• {{ code }}<br>{% endfor %}{% if not forloop.last %}<br>{% endif %}{% endfor %}">
                                            <i class="fas fa-info-circle"></i> 전체 서비스 정보 보기
                                        </small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if item.is_group %}
                                    <input type="text" 
                                           name="code_{{ item.code }}" 
                                           value="{{ item.code }}" 
                                           class="form-control form-control-sm" 
                                           style="font-size: 0.65rem; min-width: 100px;">
                                {% else %}
                                    <input type="text" 
                                           name="code_{{ item.code }}" 
                                           value="{{ item.code }}" 
                                           class="form-control form-control-sm" 
                                           style="font-size: 0.65rem; min-width: 100px;">
                                {% endif %}
                            </td>
                            {% for month in months %}
                            <td style="font-size: 0.7rem;">{{ item.monthly_sales|get_item:month|default:0|floatformat:"0"|intcomma }}</td>
                            <td style="font-size: 0.7rem;">
                                {% with change=item.monthly_changes|get_item:month|default:0 %}
                                    {% if not is_current_year or month < current_month %}
                                        {% if change > 0 %}
                                            <span class="change-positive">+{{ change|floatformat:"0"|intcomma }}</span>
                                        {% elif change < 0 %}
                                            <span class="change-negative">{{ change|floatformat:"0"|intcomma }}</span>
                                        {% else %}
                                            <span class="change-zero">0</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            {% endfor %}
                            <td style="font-size: 0.7rem; font-weight: bold;">{{ item.total_amount|floatformat:"0"|intcomma }}</td>
                        </tr>
                                                 {% empty %}
                         <tr>
                             <td colspan="{{ months|length|multiply:2|add:9 }}" class="text-center text-muted">
                                 데이터가 없습니다.
                             </td>
                         </tr>
                         {% endfor %}

                         {# Spacer row #}
                         <tr><td class="p-1" colspan="{{ 10|add:months|length|multiply:2 }}" style="border-left: 0; border-right: 0; background-color: transparent !important;"></td></tr>

                         {# 유형별 합계 #}
                         {% for type_summary in type_summaries %}
                         <tr>
                             <td colspan="7" class="text-start ps-3">{{ type_summary.name }}</td>
                             <td>{{ type_summary.count }}</td>
                             {% for month in months %}
                             <td>{{ type_summary.monthly_amounts|get_item:month|default:0|floatformat:"0"|intcomma }}</td>
                             <td>-</td>
                             {% endfor %}
                             <td colspan="2">{{ type_summary.total_amount|floatformat:"0"|intcomma }}</td>
                         </tr>
                         {% endfor %}

                         {# Spacer row #}
                         <tr><td class="p-1" colspan="{{ 10|add:months|length|multiply:2 }}" style="border-left: 0; border-right: 0; background-color: transparent !important;"></td></tr>

                         {# 월별 손익 #}
                         <tr>
                             <td colspan="8" class="text-start ps-3">매출</td>
                             {% for month in months %}
                             <td>{{ revenue_monthly|get_item:month|default:0|floatformat:"0"|intcomma }}</td>
                             <td>
                                 {% with change=revenue_changes|get_item:month|default:0 %}
                                     {% if not is_current_year or month < current_month %}
                                         {% if change > 0 %}
                                             <span class="change-positive">+{{ change|floatformat:"0"|intcomma }}</span>
                                         {% elif change < 0 %}
                                             <span class="change-negative">{{ change|floatformat:"0"|intcomma }}</span>
                                         {% else %}
                                             <span class="change-zero">0</span>
                                         {% endif %}
                                     {% else %}
                                         <span class="text-muted">-</span>
                                     {% endif %}
                                 {% endwith %}
                             </td>
                             {% endfor %}
                             <td colspan="2">{{ total_revenue|floatformat:"0"|intcomma }}</td>
                         </tr>
                         <tr>
                             <td colspan="8" class="text-start ps-3">매입</td>
                             {% for month in months %}
                             <td>{{ purchase_monthly|get_item:month|default:0|floatformat:"0"|intcomma }}</td>
                             <td>
                                 {% with change=purchase_changes|get_item:month|default:0 %}
                                     {% if not is_current_year or month < current_month %}
                                         {% if change > 0 %}
                                             <span class="change-positive">+{{ change|floatformat:"0"|intcomma }}</span>
                                         {% elif change < 0 %}
                                             <span class="change-negative">{{ change|floatformat:"0"|intcomma }}</span>
                                         {% else %}
                                             <span class="change-zero">0</span>
                                         {% endif %}
                                     {% else %}
                                         <span class="text-muted">-</span>
                                     {% endif %}
                                 {% endwith %}
                             </td>
                             {% endfor %}
                             <td colspan="2">{{ total_purchase|floatformat:"0"|intcomma }}</td>
                         </tr>
                         
                         {# Spacer row #}
                         <tr><td class="p-1" colspan="{{ 10|add:months|length|multiply:2 }}" style="border-left: 0; border-right: 0; background-color: transparent !important;"></td></tr>
                         
                         <tr class="total-row">
                             <td colspan="8" class="text-start ps-3">매출총이익</td>
                             {% for month in months %}
                             <td>{{ gross_profit_monthly|get_item:month|default:0|floatformat:"0"|intcomma }}</td>
                             <td>
                                 {% with change=gross_profit_changes|get_item:month|default:0 %}
                                     {% if not is_current_year or month < current_month %}
                                         {% if change > 0 %}
                                             <span class="change-positive">+{{ change|floatformat:"0"|intcomma }}</span>
                                         {% elif change < 0 %}
                                             <span class="change-negative">{{ change|floatformat:"0"|intcomma }}</span>
                                         {% else %}
                                             <span class="change-zero">0</span>
                                         {% endif %}
                                     {% else %}
                                         <span class="text-muted">-</span>
                                     {% endif %}
                                 {% endwith %}
                             </td>
                             {% endfor %}
                             <td colspan="2">{{ total_gross_profit|floatformat:"0"|intcomma }}</td>
                         </tr>
                         <tr>
                             <td colspan="8" class="text-start ps-3">이익율</td>
                             {% for month in months %}
                             <td>{{ profit_rate_monthly|get_item:month|default:0|floatformat:"1" }}%</td>
                             <td>-</td>
                             {% endfor %}
                             <td colspan="2">{{ total_profit_rate|floatformat:"1" }}%</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
             
             <!-- 수기 입력 항목 저장 버튼 -->
             <div class="d-flex justify-content-end mt-3">
                 <button type="submit" name="save_changes" value="true" class="btn btn-info btn-sm" form="mainForm">
                     <i class="fas fa-save"></i> 수기 입력 항목 저장
                 </button>
             </div>
         </form>
     </div>
</div>

<script>
    // 검색 결과 저장 변수
    let searchResults = [];
    
    // 폼 제출 핸들러 - 엔터키로 인한 자동 제출 방지
    function handleFormSubmit(event) {
        // 현재 포커스된 요소 확인
        const activeElement = document.activeElement;
        
        // 검색 입력창에서 엔터를 누른 경우 검색 실행
        if (activeElement && activeElement.id === 'searchText') {
            event.preventDefault();
            document.getElementById('searchBtn').click();
            return false;
        }
        
        // 수기 입력 항목 저장 버튼이 클릭된 경우 폼 제출 허용
        if (event.submitter && event.submitter.name === 'save_changes') {
            // 비활성화된 필드들을 폼 제출에서 제외
            const disabledFields = document.querySelectorAll('select[disabled], input[disabled]');
            disabledFields.forEach(field => {
                field.name = ''; // name 속성을 제거하여 POST 데이터에서 제외
            });
            return true;
        }
        
        // 다른 입력창에서 엔터를 누른 경우 폼 제출 방지
        if (activeElement && (
            activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'SELECT' ||
            activeElement.tagName === 'TEXTAREA'
        )) {
            // 검색 입력창이 아닌 경우에만 제출 방지
            if (activeElement.id !== 'searchText') {
                event.preventDefault();
                return false;
            }
        }
        
        // 비활성화된 필드들을 폼 제출에서 제외
        const disabledFields = document.querySelectorAll('select[disabled], input[disabled]');
        disabledFields.forEach(field => {
            field.name = ''; // name 속성을 제거하여 POST 데이터에서 제외
        });
        
        // 정상적인 버튼 클릭으로 제출된 경우는 허용
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Document ready');
        
        // 툴크 초기화
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // 테이블 전체선택 체크박스
        const selectAllCheckbox = document.getElementById('selectAllRows');
        selectAllCheckbox.addEventListener('change', function() {
            console.log('Select all changed:', this.checked);
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateDeleteButtonState();
            updateGroupingButtons();
        });

        // 개별 체크박스 상태 변경 시 삭제 버튼 상태 업데이트
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('row-checkbox')) {
                updateDeleteButtonState();
                updateGroupingButtons();
            }
        });

        // 삭제 버튼 상태 업데이트 함수
        function updateDeleteButtonState() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedRows');
            const ungroupBtn = document.getElementById('ungroupSelectedRows');
            
            if (selectedRows.length === 0) {
                deleteBtn.disabled = true;
                deleteBtn.classList.add('disabled');
                ungroupBtn.disabled = true;
                ungroupBtn.classList.add('disabled');
            } else {
                deleteBtn.disabled = false;
                deleteBtn.classList.remove('disabled');
                
                // 선택된 행 중 그룹이 있는지 확인
                const hasGroups = Array.from(selectedRows).some(checkbox => {
                    const row = checkbox.closest('tr');
                    return row.dataset.isGroup === 'true';
                });
                
                ungroupBtn.disabled = !hasGroups;
                if (hasGroups) {
                    ungroupBtn.classList.remove('disabled');
                } else {
                    ungroupBtn.classList.add('disabled');
                }
            }
        }

        // 그룹화 버튼 상태 업데이트 함수
        function updateGroupingButtons() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const groupingSection = document.getElementById('groupingSection');
            const createNewGroupBtn = document.getElementById('createNewGroupBtn');
            const addToGroupBtn = document.getElementById('addToGroupBtn');
            const existingGroupSelect = document.getElementById('existingGroupSelect');
            
            if (selectedRows.length > 0) {
                // 그룹화 섹션 표시
                groupingSection.style.display = 'block';
                
                // 새 그룹 생성 버튼 활성화 (1개 이상이면 새 그룹 생성 가능)
                createNewGroupBtn.disabled = selectedRows.length < 1;
                
                // 기존 그룹에 추가 버튼 활성화 (그룹 선택 시)
                addToGroupBtn.disabled = !existingGroupSelect.value;
                
                // 선택된 항목들을 하이라이트
                selectedRows.forEach(checkbox => {
                    checkbox.closest('tr').style.backgroundColor = '#fff3cd';
                });
            } else {
                // 선택된 항목이 없으면 섹션 숨김
                groupingSection.style.display = 'none';
                
                // 검색 결과가 아닌 경우 하이라이트 제거
                if (searchResults.length === 0) {
                    document.querySelectorAll('tbody tr').forEach(row => {
                        row.style.backgroundColor = '';
                    });
                }
            }
        }

        // 일괄 수정 적용
        const applyBulkChangesBtn = document.getElementById('applyBulkChanges');
        applyBulkChangesBtn.addEventListener('click', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            console.log('Selected rows:', selectedRows.length);
            
            if (selectedRows.length === 0) {
                alert('수정할 항목을 선택해주세요.');
                return;
            }

            const changes = {};
            const bulkIssueType = document.getElementById('bulkIssueType').value;
            const bulkSettlementPeriod = document.getElementById('bulkSettlementPeriod').value;
            const bulkSettlementDepartment = document.getElementById('bulkSettlementDepartment').value;
            const bulkCompanyName = document.getElementById('bulkCompanyName').value;
            const bulkServiceName = document.getElementById('bulkServiceName').value;
            const bulkGroupCode = document.getElementById('bulkGroupCode').value;

            // 값이 있는 경우에만 changes 객체에 추가
            if (bulkIssueType) changes.issueType = bulkIssueType;
            if (bulkSettlementPeriod) changes.settlementPeriod = bulkSettlementPeriod;
            if (bulkSettlementDepartment) changes.settlementDepartment = bulkSettlementDepartment;
            if (bulkCompanyName) changes.companyName = bulkCompanyName;
            if (bulkServiceName) changes.serviceName = bulkServiceName;
            if (bulkGroupCode) changes.groupCode = bulkGroupCode;

            if (Object.keys(changes).length === 0) {
                alert('수정할 값을 입력해주세요.');
                return;
            }

            // 선택된 행들에 대해 변경사항 적용
            selectedRows.forEach(function(checkbox) {
                const code = checkbox.value;
                const row = checkbox.closest('tr');
                console.log('Processing row with code:', code);

                if (changes.issueType) {
                    const issueTypeSelect = row.querySelector('select[name="issue_type_' + code + '"]');
                    if (issueTypeSelect) issueTypeSelect.value = changes.issueType;
                }
                if (changes.settlementPeriod) {
                    const settlementPeriodSelect = row.querySelector('select[name="settlement_period_' + code + '"]');
                    if (settlementPeriodSelect) settlementPeriodSelect.value = changes.settlementPeriod;
                }
                if (changes.settlementDepartment) {
                    const settlementDepartmentSelect = row.querySelector('select[name="settlement_department_' + code + '"]');
                    if (settlementDepartmentSelect) settlementDepartmentSelect.value = changes.settlementDepartment;
                }
                if (changes.companyName) {
                    const companyNameInput = row.querySelector('input[name="company_name_' + code + '"]');
                    if (companyNameInput) companyNameInput.value = changes.companyName;
                }
                if (changes.serviceName) {
                    const serviceNameInput = row.querySelector('input[name="service_name_' + code + '"]');
                    if (serviceNameInput) serviceNameInput.value = changes.serviceName;
                }
                if (changes.groupCode) {
                    const groupCodeInput = row.querySelector('input[name="code_' + code + '"]');
                    if (groupCodeInput) groupCodeInput.value = changes.groupCode;
                }
            });

            alert('일괄 수정이 완료되었습니다. "수기항목 저장" 버튼을 클릭하여 저장하세요.');
        });

        // 선택된 행 삭제
        const deleteSelectedRowsBtn = document.getElementById('deleteSelectedRows');
        deleteSelectedRowsBtn.addEventListener('click', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            console.log('Selected rows for deletion:', selectedRows.length);
            
            if (selectedRows.length === 0) {
                alert('삭제할 항목을 선택해주세요.');
                return;
            }

            // 삭제 확인
            if (!confirm(`선택된 ${selectedRows.length}개 항목을 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }

            // 삭제할 코드들을 수집
            const codesToDelete = [];
            selectedRows.forEach(function(checkbox) {
                codesToDelete.push(checkbox.value);
            });

            // 서버에 삭제 요청
            fetch('{% url "sales_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'delete',
                    codes: codesToDelete
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('삭제 중 오류가 발생했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('삭제 중 오류가 발생했습니다.');
            });
        });

        // 선택된 행 일괄 그룹해제
        const ungroupSelectedRowsBtn = document.getElementById('ungroupSelectedRows');
        ungroupSelectedRowsBtn.addEventListener('click', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            console.log('Selected rows for ungrouping:', selectedRows.length);
            
            if (selectedRows.length === 0) {
                alert('그룹 해제할 항목을 선택해주세요.');
                return;
            }

            // 선택된 그룹들만 필터링
            const selectedGroups = Array.from(selectedRows).filter(checkbox => {
                const row = checkbox.closest('tr');
                return row.dataset.isGroup === 'true';
            });

            if (selectedGroups.length === 0) {
                alert('그룹 항목을 선택해주세요.');
                return;
            }

            // 그룹 해제 확인
            if (!confirm(`선택된 ${selectedGroups.length}개 그룹을 해제하시겠습니까?\n\n그룹에 속한 모든 서비스들이 개별 항목으로 분리됩니다.`)) {
                return;
            }

            // 그룹 해제할 코드들을 수집
            const codesToUngroup = [];
            selectedGroups.forEach(function(checkbox) {
                codesToUngroup.push(checkbox.value);
            });

            // 서버에 그룹 해제 요청
            fetch('{% url "sales_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'ungroup_multiple',
                    codes: codesToUngroup
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('그룹 해제 중 오류가 발생했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('그룹 해제 중 오류가 발생했습니다.');
            });
        });

        // 검색 및 그룹화 기능
        let searchResults = [];
        let existingGroups = [];

        // 페이지 로드 시 기존 그룹 목록 로드
        function loadExistingGroups() {
            fetch('{% url "sales_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'get_groups'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    existingGroups = data.groups;
                    updateGroupDropdown();
                }
            })
            .catch(error => {
                console.error('Error loading groups:', error);
            });
        }

        // 그룹 드롭다운 업데이트
        function updateGroupDropdown() {
            const select = document.getElementById('existingGroupSelect');
            select.innerHTML = '<option value="">기존 그룹 선택...</option>';
            
            existingGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.group_code;
                option.textContent = `${group.group_name} (${group.service_count}개 항목)`;
                select.appendChild(option);
            });
        }

        // 기존 그룹 목록 로드 함수
        function loadExistingGroups() {
            const existingGroupSelect = document.getElementById('existingGroupSelect');
            existingGroupSelect.innerHTML = '<option value="">기존 그룹 선택...</option>';
            
            existingGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.group_code;
                option.textContent = group.group_name;
                existingGroupSelect.appendChild(option);
            });
        }
        
        // 페이지 로드 시 그룹 목록 로드
        loadExistingGroups();

        // 검색 기능
        document.getElementById('searchBtn').addEventListener('click', function() {
            const searchText = document.getElementById('searchText').value.trim().toLowerCase();
            const searchType = document.getElementById('searchType').value;
            
            if (!searchText) {
                alert('검색어를 입력해주세요.');
                return;
            }

            // 모든 체크박스 초기화
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });

            // 검색 조건에 맞는 행 찾기
            const tableRows = document.querySelectorAll('tbody tr');
            searchResults = [];

            tableRows.forEach((row, index) => {
                const checkbox = row.querySelector('.row-checkbox');
                if (!checkbox) return; // 헤더나 요약 행 제외

                const companyName = row.querySelector('input[name^="company_name_"]')?.value || '';
                const serviceName = row.querySelector('input[name^="service_name_"]')?.value || '';
                
                let isMatch = false;
                
                switch(searchType) {
                    case 'company':
                        isMatch = companyName.toLowerCase().includes(searchText);
                        break;
                    case 'service':
                        isMatch = serviceName.toLowerCase().includes(searchText);
                        break;
                    case 'both':
                    default:
                        isMatch = companyName.toLowerCase().includes(searchText) || 
                                 serviceName.toLowerCase().includes(searchText);
                        break;
                }

                if (isMatch) {
                    checkbox.checked = true;
                    searchResults.push(checkbox.value);
                    row.style.backgroundColor = '#fff3cd'; // 하이라이트
                } else {
                    row.style.backgroundColor = '';
                }
            });

            // 검색 결과 표시
            const resultCount = searchResults.length;
            document.getElementById('resultCount').textContent = resultCount;
            document.getElementById('searchResults').style.display = resultCount > 0 ? 'block' : 'none';
            
            // 그룹화 버튼 상태 업데이트
            updateGroupingButtons();
            
            updateDeleteButtonState();

            if (resultCount === 0) {
                alert('검색 조건에 맞는 항목이 없습니다.');
            } else {
                // 검색된 첫 번째 항목으로 스크롤
                const firstMatch = document.querySelector('.row-checkbox:checked');
                if (firstMatch) {
                    firstMatch.closest('tr').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // 전체 선택/해제
        document.getElementById('selectAllSearchResults').addEventListener('click', function() {
            searchResults.forEach(code => {
                const checkbox = document.querySelector(`.row-checkbox[value="${code}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('tr').style.backgroundColor = '#fff3cd';
                }
            });
            updateDeleteButtonState();
            updateGroupingButtons();
        });

        document.getElementById('deselectAllSearchResults').addEventListener('click', function() {
            searchResults.forEach(code => {
                const checkbox = document.querySelector(`.row-checkbox[value="${code}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.closest('tr').style.backgroundColor = '';
                }
            });
            updateDeleteButtonState();
            updateGroupingButtons();
        });

        // 새 그룹 생성 기능
        document.getElementById('createNewGroupBtn').addEventListener('click', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            
            if (selectedRows.length < 1) {
                alert('그룹화하려면 1개 이상의 항목을 선택해주세요.');
                return;
            }

            // 선택된 항목들의 정보 수집
            const selectedCodes = [];
            const selectedData = [];
            let hasGroups = false;
            let hasIndividual = false;
            
            selectedRows.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const code = checkbox.value;
                const companyName = row.querySelector('input[name^="company_name_"]')?.value || '';
                const serviceName = row.querySelector('input[name^="service_name_"]')?.value || '';
                const isGroup = row.dataset.isGroup === 'true';
                
                // 중복 코드 제거
                if (!selectedCodes.includes(code)) {
                    selectedCodes.push(code);
                    selectedData.push({
                        code: code,
                        companyName: companyName,
                        serviceName: serviceName,
                        row: row,
                        isGroup: isGroup
                    });
                    
                    if (isGroup) {
                        hasGroups = true;
                    } else {
                        hasIndividual = true;
                    }
                }
            });

            // 중복 제거 후 항목 수 확인
            if (selectedCodes.length < 1) {
                alert('그룹화하려면 1개 이상의 고유한 항목을 선택해주세요.');
                return;
            }

            // 그룹과 개별 항목이 혼재된 경우 경고 메시지
            let confirmMessage = '';
            if (hasGroups && hasIndividual) {
                confirmMessage = `그룹과 개별 항목이 함께 선택되었습니다.\n\n기존 그룹들이 해제되고 모든 항목이 새로운 그룹으로 재그룹화됩니다.\n\n계속하시겠습니까?`;
            } else if (hasGroups) {
                confirmMessage = `그룹 항목들이 선택되었습니다.\n\n기존 그룹들이 해제되고 새로운 그룹으로 재그룹화됩니다.\n\n계속하시겠습니까?`;
            } else {
                confirmMessage = `선택된 ${selectedCodes.length}개 항목을 새 그룹으로 그룹화하시겠습니까?`;
            }

            // 그룹명 입력 받기
            const groupName = prompt('그룹명을 입력해주세요:', '통합 그룹');
            if (!groupName) return;

            // 확인 메시지 표시
            if (!confirm(confirmMessage)) {
                return;
            }

            // 디버깅: 선택된 코드들 출력
            console.log('Selected codes for grouping:', selectedCodes);
            console.log('Selected data:', selectedData);
            console.log('Has groups:', hasGroups, 'Has individual:', hasIndividual);

            // 서버에 그룹화 요청
            fetch('{% url "sales_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'group',
                    codes: selectedCodes,
                    groupName: groupName
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Grouping response:', data);
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('그룹화 중 오류가 발생했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('그룹화 중 오류가 발생했습니다.');
            });
        });

        // 검색 초기화
        document.getElementById('clearSearchBtn').addEventListener('click', function() {
            document.getElementById('searchText').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('groupingSection').style.display = 'none';
            
            // 모든 하이라이트 제거
            document.querySelectorAll('tbody tr').forEach(row => {
                row.style.backgroundColor = '';
            });
            
            // 모든 체크박스 해제
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // 그룹 선택 초기화
            document.getElementById('existingGroupSelect').value = '';
            document.getElementById('addToGroupBtn').disabled = true;
            document.getElementById('createNewGroupBtn').disabled = true;
            
            // 검색 결과 초기화
            searchResults = [];
            
            // 버튼 상태 업데이트
            updateDeleteButtonState();
            updateGroupingButtons();
        });

        // Enter 키로 검색 실행
        document.getElementById('searchText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // 기존 그룹 선택 시 버튼 활성화
        document.getElementById('existingGroupSelect').addEventListener('change', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const addToGroupBtn = document.getElementById('addToGroupBtn');
            addToGroupBtn.disabled = !this.value || selectedRows.length === 0;
        });

        // 기존 그룹에 추가
        document.getElementById('addToGroupBtn').addEventListener('click', function() {
            const selectedRows = document.querySelectorAll('.row-checkbox:checked');
            const selectedGroupCode = document.getElementById('existingGroupSelect').value;
            
            if (selectedRows.length === 0) {
                alert('추가할 항목을 선택해주세요.');
                return;
            }
            
            if (!selectedGroupCode) {
                alert('추가할 그룹을 선택해주세요.');
                return;
            }

            // 선택된 항목들의 정보 수집
            const selectedCodes = [];
            
            selectedRows.forEach(checkbox => {
                const code = checkbox.value;
                // 중복 코드 제거
                if (!selectedCodes.includes(code)) {
                    selectedCodes.push(code);
                }
            });

            // 중복 제거 후 항목 수 확인
            if (selectedCodes.length === 0) {
                alert('추가할 고유한 항목이 없습니다.');
                return;
            }

            // 선택한 그룹 정보 가져오기
            const selectedGroup = existingGroups.find(group => group.group_code === selectedGroupCode);
            if (!selectedGroup) {
                alert('선택한 그룹을 찾을 수 없습니다.');
                return;
            }

            if (!confirm(`선택된 ${selectedCodes.length}개 항목을 "${selectedGroup.group_name}" 그룹에 추가하시겠습니까?`)) {
                return;
            }

            // 서버에 그룹 추가 요청
            fetch('{% url "sales_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    action: 'group',
                    codes: selectedCodes,
                    existingGroupCode: selectedGroupCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('그룹 추가 중 오류가 발생했습니다: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('그룹 추가 중 오류가 발생했습니다.');
            });
        });

        // 초기 상태 설정
        updateDeleteButtonState();
        updateGroupingButtons();
        
        // 엑셀 업로드 폼 처리
        const excelUploadForm = document.getElementById('excelUploadForm');
        if (excelUploadForm) {
            excelUploadForm.addEventListener('submit', function(event) {
                const fileInput = document.getElementById('excel_file');
                if (!fileInput.files || fileInput.files.length === 0) {
                    event.preventDefault();
                    alert('엑셀 파일을 선택해주세요.');
                    return false;
                }
                
                const file = fileInput.files[0];
                const allowedTypes = ['.xls', '.xlsx'];
                const fileName = file.name.toLowerCase();
                
                if (!allowedTypes.some(type => fileName.endsWith(type))) {
                    event.preventDefault();
                    alert('지원하지 않는 파일 형식입니다. .xls 또는 .xlsx 파일을 업로드해주세요.');
                    return false;
                }
                
                // 파일 크기 체크 (50MB 제한)
                if (file.size > 50 * 1024 * 1024) {
                    event.preventDefault();
                    alert('파일 크기가 너무 큽니다. 50MB 이하의 파일을 업로드해주세요.');
                    return false;
                }
                
                // 업로드 진행 중 표시
                const submitBtn = event.submitter;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 업로드 중...';
                submitBtn.disabled = true;
                
                // 폼 제출 후 버튼 상태 복원
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 5000);
            });
        }
    });

    // 월별 조정 저장 함수
    function saveMonthlyAdjustment(input) {
        const yearMonth = input.getAttribute('data-year-month');
        const adjustmentType = input.getAttribute('data-adjustment-type');
        const salesType = input.getAttribute('data-sales-type');
        let adjustmentAmount = null;
        let adjustmentNote = null;
        let taxDeadline = null;
        
        // 입력 타입에 따라 값 추출
        if (input.type === 'number') {
            adjustmentAmount = parseFloat(input.value) || 0;
            
            // 조정금액이 변경된 경우 조정 후 매출확정액 자동 계산
            if (yearMonth === '{{ prev_month }}' && input.classList.contains('adjustment-input')) {
                updateConfirmedAmount(salesType, adjustmentAmount);
            }
        } else if (input.type === 'text') {
            adjustmentNote = input.value.trim();
        } else if (input.type === 'date') {
            taxDeadline = input.value;
        }
        
        // API 호출 데이터 준비 (null이 아닌 값만 포함)
        const requestData = {
            year_month: yearMonth,
            adjustment_type: adjustmentType,
            sales_type: salesType
        };
        
        if (adjustmentAmount !== null) {
            requestData.adjustment_amount = adjustmentAmount;
        }
        if (adjustmentNote !== null) {
            requestData.adjustment_note = adjustmentNote;
        }
        if (taxDeadline !== null) {
            requestData.tax_deadline = taxDeadline;
        }
        
        // API 호출
        fetch('{% url "save_monthly_adjustment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공 시 합계 업데이트 (전월 조정금액인 경우에만)
                if (yearMonth === '{{ prev_month }}' && adjustmentType === 'sales') {
                    updatePrevMonthTotals();
                }
                
                // 성공 메시지 표시 (선택사항)
                if (data.action === 'created') {
                    console.log('월별 조정이 저장되었습니다.');
                } else if (data.action === 'updated') {
                    console.log('월별 조정이 수정되었습니다.');
                }
            } else {
                alert('저장 중 오류가 발생했습니다: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('저장 중 오류가 발생했습니다.');
        });
    }

    // 조정 후 매출확정액 자동 계산 함수
    function updateConfirmedAmount(salesType, adjustmentAmount) {
        // 전월 테이블에서 해당 행의 조정 전 매출추정액과 조정 후 매출확정액 셀 찾기
        const prevTable = document.getElementById('prev-sales-table');
        if (!prevTable) return;
        
        const row = prevTable.querySelector(`[data-sales-type="${salesType}"]`).closest('tr');
        if (!row) return;
        
        const estimateCell = row.cells[1]; // 조정 전 매출추정액
        const confirmedCell = row.cells[2]; // 조정 후 매출확정액
        
        if (!estimateCell || !confirmedCell) return;
        
        // 조정 전 매출추정액 값 가져오기
        const estimateAmount = Math.floor(parseFloat(estimateCell.textContent.replace(/,/g, '')) || 0);
        
        // 조정 후 매출확정액 계산 (조정 전 + 조정금액)
        const confirmedAmount = estimateAmount + Math.floor(adjustmentAmount);
        
        // 조정 후 매출확정액 업데이트
        confirmedCell.textContent = confirmedAmount.toLocaleString();
        
        // 합계 업데이트
        updatePrevMonthTotals();
    }

    // 전월 합계 업데이트 함수
    function updatePrevMonthTotals() {
        const rows = document.querySelectorAll('#prev-sales-table tbody tr:not(.total-row)');
        let totalEstimate = 0;
        let totalConfirmed = 0;
        let totalAdjust = 0;
        
        rows.forEach(row => {
            const estimateCell = row.cells[1];
            const confirmedCell = row.cells[2];
            const adjustInput = row.querySelector('.adjustment-input');
            
            // 조정 전 매출추정액 (조정금액 제외)
            if (estimateCell && estimateCell.textContent) {
                totalEstimate += Math.floor(parseFloat(estimateCell.textContent.replace(/,/g, '')) || 0);
            }
            // 조정 후 매출확정액 (조정 전 + 조정금액)
            if (confirmedCell && confirmedCell.textContent) {
                totalConfirmed += Math.floor(parseFloat(confirmedCell.textContent.replace(/,/g, '')) || 0);
            }
            // 조정금액만 별도 합계
            if (adjustInput && adjustInput.value) {
                totalAdjust += Math.floor(parseFloat(adjustInput.value) || 0);
            }
        });
        
        // 합계 행 업데이트
        const totalRow = document.querySelector('#prev-sales-table .total-row');
        if (totalRow) {
            totalRow.cells[1].textContent = totalEstimate.toLocaleString(); // 조정 전 매출추정액 합계
            totalRow.cells[2].textContent = totalConfirmed.toLocaleString(); // 조정 후 매출확정액 합계
            totalRow.cells[3].textContent = totalAdjust.toLocaleString(); // 조정금액 합계
        }
    }

    // 월별 합계 업데이트 함수 (현재월 매출추정액은 서버에서 계산된 값을 유지)
    function updateMonthlyTotals(yearMonth, adjustmentType) {
        // 현재월 매출추정액은 서버에서 계산된 값을 그대로 유지하므로 수정하지 않음
        // 이 함수는 전월 조정 관련 계산에만 사용됨
    }

    // 페이지 로드 시 전월 합계만 계산 (현재월은 서버에서 계산된 값 유지)
    document.addEventListener('DOMContentLoaded', function() {
        updatePrevMonthTotals();
    });

    function openDepartmentManagement() {
        // 팝업 창으로 정산주관부서 관리 페이지 열기
        const popup = window.open(
            '{% url "settlement_department_list" %}',
            'department_management',
            'width=800,height=600,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no'
        );
        
        // 팝업이 닫힐 때 페이지 새로고침
        const checkClosed = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkClosed);
                location.reload();
            }
        }, 1000);
    }
</script>

{% endblock %}